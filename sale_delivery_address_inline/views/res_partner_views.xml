<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario extendida para partners -->
    <record id="view_partner_form_delivery_extended" model="ir.ui.view">
        <field name="name">res.partner.form.delivery.extended</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            
            <!-- Botón para gestionar direcciones (solo para empresas padre) -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_delivery_addresses"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="parent_id or not is_distributor">
                    <field name="delivery_address_count" widget="statinfo" 
                           string="Direcciones"/>
                </button>
            </xpath>

            <!-- Añadir página de configuración de distribución -->
            <xpath expr="//notebook" position="inside">
                <page string="🚛 Distribución" name="distribution_config" 
                      invisible="parent_id or type != 'contact'">
                    <group>
                        <group string="Configuración">
                            <field name="is_distributor"/>
                            <field name="distributor_type" invisible="not is_distributor"/>
                        </group>
                        <group string="Estadísticas" invisible="not is_distributor">
                            <field name="delivery_address_count"/>
                        </group>
                    </group>
                    
                    <separator string="Información Logística"/>
                    <group>
                        <group>
                            <field name="truck_access"/>
                            <field name="loading_equipment"/>
                        </group>
                        <group>
                            <field name="delivery_schedule_notes" 
                                   placeholder="Horarios, restricciones, observaciones..."/>
                        </group>
                    </group>

                    <div class="alert alert-info mt-3" role="alert" 
                         invisible="not is_distributor">
                        <strong>ℹ️ Modo Distribuidor Activo</strong><br/>
                        Este cliente puede tener múltiples direcciones de entrega.
                        Use el botón superior para gestionarlas.
                    </div>
                </page>

                <!-- Página de Proyecto (solo para direcciones temporales) -->
                <page string="📦 Proyecto" name="project_data" 
                      invisible="not is_temporary_address or type != 'delivery'">
                    <group>
                        <group string="Identificación">
                            <field name="is_temporary_address"/>
                            <field name="project_reference"/>
                            <field name="project_status"/>
                        </group>
                        <group string="Fechas">
                            <field name="project_start_date"/>
                            <field name="project_end_date"/>
                        </group>
                    </group>
                    
                    <group string="Detalles del Proyecto">
                        <field name="project_description" nolabel="1" 
                               placeholder="Descripción detallada del proyecto..."/>
                    </group>

                    <separator string="Contacto en Obra"/>
                    <group>
                        <group>
                            <field name="site_contact_name"/>
                            <field name="site_contact_phone"/>
                        </group>
                    </group>

                    <div class="alert alert-warning mt-3" role="alert">
                        <strong>⚠️ Dirección Temporal</strong><br/>
                        Esta dirección está marcada como temporal y asociada al proyecto 
                        <strong><field name="project_reference" readonly="1"/></strong>.
                        Se recomienda archivarla al finalizar el proyecto.
                    </div>
                </page>
            </xpath>

            <!-- Indicador visual en dirección si es temporal -->
            <xpath expr="//field[@name='type']" position="after">
                <field name="is_temporary_address" 
                       invisible="type != 'delivery'"/>
            </xpath>

        </field>
    </record>

    <!-- Vista de árbol extendida para direcciones -->
    <record id="view_partner_tree_delivery" model="ir.ui.view">
        <field name="name">res.partner.tree.delivery</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='display_name']" position="after">
                <field name="is_temporary_address" optional="show"/>
                <field name="project_reference" optional="show"/>
                <field name="project_status" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Filtros de búsqueda mejorados -->
    <record id="view_partner_search_delivery_extended" model="ir.ui.view">
        <field name="name">res.partner.search.delivery.extended</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="project_reference"/>
            </xpath>

            <xpath expr="//filter[@name='customer']" position="after">
                <separator/>
                <filter string="Distribuidores" name="distributors"
                        domain="[('is_distributor', '=', True)]"/>
                <filter string="Direcciones Temporales" name="temporary_addresses"
                        domain="[('is_temporary_address', '=', True)]"/>
                <filter string="Direcciones Permanentes" name="permanent_addresses"
                        domain="[('type', '=', 'delivery'), ('is_temporary_address', '=', False)]"/>
                <separator/>
                <filter string="Proyectos Activos" name="active_projects"
                        domain="[('is_temporary_address', '=', True), ('project_status', '=', 'active')]"/>
                <filter string="Proyectos Completados" name="completed_projects"
                        domain="[('is_temporary_address', '=', True), ('project_status', '=', 'completed')]"/>
            </xpath>

            <xpath expr="//group[@name='group_by']" position="inside">
                <filter string="Tipo Distribuidor" name="distributor_type_groupby" 
                        context="{'group_by': 'distributor_type'}"/>
                <filter string="Estado Proyecto" name="project_status_groupby" 
                        context="{'group_by': 'project_status'}"/>
                <filter string="Compañía" name="company_groupby" 
                        context="{'group_by': 'company_id'}"/>
            </xpath>
        </field>
    </record>

    <!-- Vista formulario para direcciones de entrega -->
    <record id="view_delivery_address_form" model="ir.ui.view">
        <field name="name">res.partner.delivery.form</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <form string="Dirección de Entrega">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" 
                                class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options='{"terminology": "archive"}'/>
                        </button>
                    </div>

                    <field name="image_128" widget="image" class="oe_avatar"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nombre de la dirección"/>
                        </h1>
                        <div invisible="not is_temporary_address">
                            <span class="badge badge-warning">📦 Dirección Temporal</span>
                            <field name="project_reference" placeholder="REF-PROYECTO"/>
                        </div>
                    </div>

                    <group>
                        <group>
                            <field name="parent_id" string="Cliente"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="type" invisible="1"/>
                            <field name="is_temporary_address"/>
                        </group>
                        <group>
                            <field name="project_status" invisible="not is_temporary_address"/>
                            <field name="project_start_date" invisible="not is_temporary_address"/>
                            <field name="project_end_date" invisible="not is_temporary_address"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Dirección" name="address">
                            <group>
                                <group>
                                    <field name="street" placeholder="Calle y número"/>
                                    <field name="street2" placeholder="Información adicional"/>
                                    <field name="city" placeholder="Ciudad"/>
                                    <field name="zip" placeholder="C.P."/>
                                </group>
                                <group>
                                    <field name="state_id" placeholder="Provincia"/>
                                    <field name="country_id" placeholder="País"/>
                                </group>
                            </group>
                        </page>

                        <page string="Contacto" name="contact">
                            <group>
                                <group>
                                    <field name="phone"/>
                                    <field name="mobile"/>
                                    <field name="email"/>
                                </group>
                                <group string="Contacto en Obra">
                                    <field name="site_contact_name"/>
                                    <field name="site_contact_phone"/>
                                </group>
                            </group>
                        </page>

                        <page string="Logística" name="logistics">
                            <group>
                                <group>
                                    <field name="truck_access"/>
                                    <field name="loading_equipment"/>
                                </group>
                                <group>
                                    <field name="delivery_schedule_notes" 
                                           placeholder="Horarios, restricciones..."/>
                                </group>
                            </group>
                        </page>

                        <page string="Proyecto" name="project" 
                              invisible="not is_temporary_address">
                            <group>
                                <field name="project_description" nolabel="1" 
                                       placeholder="Descripción del proyecto..."/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Action para direcciones de entrega -->
    <record id="action_partner_delivery_addresses" model="ir.actions.act_window">
        <field name="name">Direcciones de Entrega</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('type', '=', 'delivery')]</field>
        <field name="context">{
            'default_type': 'delivery',
            'search_default_temporary_addresses': 1
        }</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('view_partner_tree_delivery')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('view_delivery_address_form')})]"/>
    </record>

</odoo>
