<odoo>
    <!-- Vista de formulario mejorada para sale.order -->
    <record id="view_order_form_delivery_inline" model="ir.ui.view">
        <field name="name">sale.order.form.delivery.inline</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- Modificar el campo partner_shipping_id -->
            <xpath expr="//field[@name='partner_shipping_id']" position="attributes">
                <attribute name="attrs">{'invisible': [('use_alternative_delivery', '=', True)]}</attribute>
                <attribute name="groups">sales_team.group_sale_salesman</attribute>
            </xpath>

            <!-- Agregar secci贸n de direcci贸n de entrega mejorada -->
            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                <div class="oe_inline address_inline" attrs="{'invisible': [('partner_id', '=', False)]}">
                    <!-- Opciones para distribuidores -->
                    <div class="alert alert-info mb-2 mt-2 p-2"
                         attrs="{'invisible': [('is_distributor_customer', '=', False)]}">
                        <div class="d-flex align-items-center">
                            <span class="mr-2"></span>
                            <strong>Modo Distribuidor:</strong>
                            <span class="ml-2">Puede seleccionar entre direcciones de entrega existentes o crear una nueva.</span>
                        </div>
                        <div class="mt-1 d-flex">
                            <field name="use_alternative_delivery" class="mr-2"/>
                            <label for="use_alternative_delivery" string="Usar Direcci贸n de Entrega Alternativa"/>
                            <div class="ml-auto text-muted">
                                <small>Los cambios se guardan autom谩ticamente y se registran en el historial.</small>
                            </div>
                        </div>
                        <!-- Selector de direcciones existentes -->
                        <div class="mt-2" attrs="{'invisible': [('use_alternative_delivery', '=', False)]}">
                            <label for="selected_delivery_partner_id" string="Direcci贸n de Entrega" class="oe_inline"/>
                            <div class="d-flex align-items-center mt-1">
                                <field name="selected_delivery_partner_id"
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       placeholder="Seleccionar direcci贸n de entrega..."
                                       class="w-75"/>
                                <button name="action_create_delivery_address"
                                        string="Nueva direcci贸n" type="object"
                                        class="btn btn-sm btn-primary ml-2"
                                        attrs="{'invisible': [('partner_id', '=', False)]}"
                                        groups="sales_team.group_sale_salesman"/>
                            </div>
                        </div>
                    </div>

                    <!-- Bloque de edici贸n de direcci贸n con dise帽o mejorado -->
                    <fieldset class="mt-3 p-3 border rounded delivery-address-fieldset"
                              attrs="{'invisible': [('partner_id', '=', False)]}">
                        <legend class="text-primary w-auto">
                            <span class="mr-1"></span>
                            <span>Detalles de Direcci贸n de Entrega</span>
                        </legend>

                        <!-- Primera fila: datos de contacto -->
                        <h6 class="text-muted mt-2 mb-2">
                            <i class="fa fa-user mr-1"></i> Datos de Contacto
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="delivery_name" string="Nombre de Contacto"/>
                                <field name="delivery_name" placeholder="Persona de contacto para entrega"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                            <div class="col-md-4">
                                <label for="delivery_phone" string="Tel茅fono de Contacto"/>
                                <field name="delivery_phone" placeholder="+34 999 888 777"
                                       widget="phone"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                            <div class="col-md-4">
                                <label for="delivery_email" string="Email de Contacto"/>
                                <field name="delivery_email" placeholder="contacto@ejemplo.com"
                                       widget="email"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                        </div>

                        <!-- Segunda fila: direcci贸n f铆sica -->
                        <h6 class="text-muted mt-3 mb-2">
                            <i class="fa fa-map-marker mr-1"></i> Direcci贸n F铆sica
                        </h6>
                        <div class="row">
                            <div class="col-md-12">
                                <label for="delivery_street" string="Direcci贸n"/>
                                <field name="delivery_street" placeholder="Calle y n煤mero"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <label for="delivery_street2" string="Informaci贸n Adicional"/>
                                <field name="delivery_street2" placeholder="Edificio, piso, puerta..."
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label for="delivery_city" string="Ciudad/Localidad"/>
                                <field name="delivery_city" placeholder="Ciudad"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                            <div class="col-md-3">
                                <label for="delivery_zip" string="C贸digo Postal"/>
                                <field name="delivery_zip" placeholder="CP"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                            <div class="col-md-2">
                                <label for="delivery_state_id" string="Provincia"/>
                                <field name="delivery_state_id" placeholder="Provincia"
                                       options="{'no_create': True}"
                                       context="{'country_id': delivery_country_id}"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                            <div class="col-md-3">
                                <label for="delivery_country_id" string="Pa铆s"/>
                                <field name="delivery_country_id" placeholder="Pa铆s"
                                       options="{'no_create': True}"
                                       attrs="{'readonly': [('state', 'in', ['sale', 'done'])]}"/>
                            </div>
                        </div>

                        <!-- Bot贸n para crear direcci贸n nueva -->
                        <div class="text-right mt-3"
                             attrs="{'invisible': ['|', ('partner_id', '=', False), ('is_distributor_customer', '=', False)]}">
                            <button name="action_create_delivery_address"
                                    string="Guardar como nueva direcci贸n"
                                    type="object"
                                    class="btn btn-sm btn-primary"
                                    groups="sales_team.group_sale_salesman"/>
                            <div class="text-muted mt-1">
                                <small>Guarda esta direcci贸n para usarla en futuros pedidos.</small>
                            </div>
                        </div>

                        <!-- Botones para gerentes en pedidos confirmados -->
                        <div class="text-right mt-3"
                             attrs="{'invisible': ['|', ('state', 'not in', ['sale', 'done']), ('partner_id', '=', False)]}"
                             groups="sales_team.group_sale_manager">
                            <button name="action_create_delivery_address"
                                    string="Modificar direcci贸n de entrega"
                                    type="object"
                                    class="btn btn-sm btn-warning"/>
                            <div class="text-muted mt-1">
                                <small>Como gerente, puede modificar la direcci贸n incluso en pedidos confirmados.</small>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Advertencia de direcci贸n modificada despu茅s de confirmaci贸n -->
                    <div class="alert alert-warning mt-2"
                         attrs="{'invisible': [('delivery_address_modified', '=', False)]}">
                        <strong>Atenci贸n:</strong> Esta direcci贸n ha sido modificada despu茅s de confirmar el pedido.
                        Aseg煤rese de que el departamento de log铆stica est谩 informado de los cambios.
                    </div>
                </div>
            </xpath>

            <!-- A帽adir campos en la vista de 谩rbol (lista) de pedidos -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="is_distributor_customer" optional="hide"/>
            </xpath>

            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                <field name="delivery_city" string="Ciudad Entrega" optional="show"/>
            </xpath>

        </field>
    </record>

    <!-- Mejoras en la vista de b煤squeda de pedidos -->
    <record id="view_sales_order_filter_delivery" model="ir.ui.view">
        <field name="name">sale.order.filter.delivery</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="delivery_city"/>
                <field name="delivery_name"/>
                <separator/>
                <filter string="Solo Distribuidores" name="distributor_orders"
                        domain="[('is_distributor_customer', '=', True)]"/>
                <filter string="Con Entrega Alternativa" name="alt_delivery"
                        domain="[('use_alternative_delivery', '=', True)]"/>
                <filter string="Direcci贸n Modificada" name="modified_address"
                        domain="[('delivery_address_modified', '=', True)]"/>
            </xpath>

            <xpath expr="//group/filter[@name='customer']" position="after">
                <filter string="Ciudad de Entrega" name="city_groupby" context="{'group_by': 'delivery_city'}"/>
                <filter string="Tipo de Entrega" name="delivery_type_groupby"
                        context="{'group_by': 'use_alternative_delivery'}"/>
            </xpath>
        </field>
    </record>
</odoo>
