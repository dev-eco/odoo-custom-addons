<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario mejorada para sale.order -->
    <record id="view_order_form_delivery_inline_extended" model="ir.ui.view">
        <field name="name">sale.order.form.delivery.inline.extended</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- Campos invisibles necesarios -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="is_distributor_customer" invisible="1"/>
                <field name="is_temporary_delivery" invisible="1"/>
                <field name="delivery_address_modified" invisible="1"/>
                <field name="delivery_project_reference" invisible="1"/>
            </xpath>
            
            <!-- Modificar el campo partner_shipping_id existente -->
            <xpath expr="//field[@name='partner_shipping_id']" position="attributes">
                <attribute name="invisible">use_alternative_delivery</attribute>
            </xpath>

            <!-- Agregar secci贸n de direcci贸n inline mejorada -->
            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                
                <!-- Indicador si es direcci贸n temporal -->
                <div class="alert alert-info mt-2" role="alert" 
                     invisible="not is_temporary_delivery">
                    <strong> Direcci贸n Temporal de Proyecto</strong><br/>
                    Proyecto: <field name="delivery_project_reference" readonly="1" class="o_form_field_text"/>
                </div>

                <!-- Advertencia si direcci贸n modificada post-confirmaci贸n -->
                <div class="alert alert-warning mt-2" role="alert" 
                     invisible="not delivery_address_modified">
                    <strong>锔 Direcci贸n Modificada</strong><br/>
                    La direcci贸n de entrega fue modificada despu茅s de confirmar el pedido.
                    Aseg煤rese de informar al departamento de log铆stica.
                </div>

                <div class="oe_inline" invisible="not partner_id">
                    
                    <!-- Opciones para distribuidores -->
                    <div class="alert alert-info mb-2 p-2" role="alert"
                         invisible="not is_distributor_customer">
                        <div class="d-flex align-items-center">
                            <span class="mr-2"></span>
                            <strong>Modo Distribuidor:</strong>
                            <span class="ml-2">Seleccione entre direcciones existentes o cree una nueva.</span>
                        </div>
                        <div class="mt-2 d-flex align-items-center">
                            <field name="use_alternative_delivery" class="mr-2"/>
                            <label for="use_alternative_delivery" string="Usar Direcci贸n Alternativa"/>
                        </div>
                        <div class="mt-1 text-muted">
                            <small>Los cambios se guardan autom谩ticamente en el historial.</small>
                        </div>

                        <!-- Selector de direcciones existentes -->
                        <div class="mt-2" invisible="not use_alternative_delivery">
                            <label for="selected_delivery_partner_id" string="Direcci贸n" class="oe_inline"/>
                            <div class="d-flex align-items-center mt-1">
                                <field name="selected_delivery_partner_id"
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       placeholder="Seleccionar direcci贸n..."
                                       class="w-75"/>
                                <button name="action_create_delivery_address"
                                        string="Nueva" type="object"
                                        class="btn btn-sm btn-primary ml-2"
                                        invisible="not partner_id"/>
                            </div>
                        </div>
                    </div>

                    <!-- Bloque de edici贸n inline -->
                    <fieldset class="mt-3 p-3 border rounded delivery-address-fieldset"
                              invisible="not partner_id">
                        <legend class="text-primary w-auto">
                            <span class="mr-1"></span>
                            <span>Detalles de Direcci贸n de Entrega</span>
                        </legend>

                        <!-- Fila 1: Datos de contacto -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="fa fa-user mr-1"></i> Datos de Contacto
                            </h6>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label for="delivery_name" string="Nombre"/>
                                    <field name="delivery_name" 
                                           placeholder="Nombre del contacto"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-12 mb-2">
                                    <label for="delivery_phone" string="Tel茅fono"/>
                                    <field name="delivery_phone" 
                                           placeholder="+34 999 888 777"
                                           widget="phone"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-12 mb-2">
                                    <label for="delivery_email" string="Email"/>
                                    <field name="delivery_email" 
                                           placeholder="contacto@ejemplo.com"
                                           widget="email"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 2: Direcci贸n f铆sica -->
                        <div>
                            <h6 class="text-muted mb-2">
                                <i class="fa fa-map-marker mr-1"></i> Direcci贸n F铆sica
                            </h6>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label for="delivery_street" string="Direcci贸n"/>
                                    <field name="delivery_street" 
                                           placeholder="Calle y n煤mero"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label for="delivery_street2" string="Info Adicional"/>
                                    <field name="delivery_street2" 
                                           placeholder="Edificio, piso, puerta..."
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_city" string="Ciudad"/>
                                    <field name="delivery_city" 
                                           placeholder="Ciudad"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_zip" string="C.P."/>
                                    <field name="delivery_zip" 
                                           placeholder="C贸digo Postal"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_state_id" string="Provincia"/>
                                    <field name="delivery_state_id" 
                                           placeholder="Provincia"
                                           options="{'no_create': True}"
                                           context="{'country_id': delivery_country_id}"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_country_id" string="Pa铆s"/>
                                    <field name="delivery_country_id" 
                                           placeholder="Pa铆s"
                                           options="{'no_create': True}"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </xpath>

            <!-- A帽adir campos en vista de 谩rbol -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="is_distributor_customer" optional="hide"/>
                <field name="is_temporary_delivery" optional="show" string="Temporal"/>
            </xpath>

            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                <field name="delivery_project_reference" optional="show" string="Ref. Proyecto"/>
                <field name="delivery_city" optional="show" string="Ciudad"/>
                <field name="delivery_phone" optional="hide"/>
            </xpath>

        </field>
    </record>

    <!-- Vista de b煤squeda mejorada -->
    <record id="view_sales_order_filter_delivery_extended" model="ir.ui.view">
        <field name="name">sale.order.filter.delivery.extended</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="delivery_city"/>
                <field name="delivery_project_reference"/>
            </xpath>

            <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                <separator/>
                <filter string="Clientes Distribuidores" name="distributor_orders"
                        domain="[('is_distributor_customer', '=', True)]"/>
                <filter string="Con Direcci贸n Alternativa" name="alt_delivery"
                        domain="[('use_alternative_delivery', '=', True)]"/>
                <filter string="Direcciones Temporales" name="temporary_delivery"
                        domain="[('is_temporary_delivery', '=', True)]"/>
                <filter string="Direcciones Modificadas" name="modified_address"
                        domain="[('delivery_address_modified', '=', True)]"/>
            </xpath>

            <xpath expr="//group/filter[@name='customer']" position="after">
                <filter string="Ciudad Entrega" name="city_groupby" 
                        context="{'group_by': 'delivery_city'}"/>
                <filter string="Tipo Entrega" name="delivery_type_groupby"
                        context="{'group_by': 'is_temporary_delivery'}"/>
                <filter string="Compa帽铆a" name="company_groupby" 
                        context="{'group_by': 'company_id'}"/>
            </xpath>
        </field>
    </record>

</odoo>
