<odoo>
    <!-- Vista de formulario mejorada para sale.order -->
    <record id="view_order_form_delivery_inline" model="ir.ui.view">
        <field name="name">sale.order.form.delivery.inline</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- A帽adir campos invisibles necesarios -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="delivery_address_modified" invisible="1"/>
            </xpath>
            
            <!-- Modificar el campo partner_shipping_id -->
            <xpath expr="//field[@name='partner_shipping_id']" position="attributes">
                <attribute name="invisible">use_alternative_delivery</attribute>
                <attribute name="groups">sales_team.group_sale_salesman</attribute>
            </xpath>

            <!-- Agregar secci贸n de direcci贸n de entrega mejorada -->
            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                <div class="oe_inline address_inline" invisible="not partner_id">
                    <!-- Opciones para distribuidores -->
                    <div class="alert alert-info mb-2 mt-2 p-2"
                         invisible="not is_distributor_customer"
                         role="alert">
                        <div class="d-flex align-items-center">
                            <span class="mr-2"></span>
                            <strong>Modo Distribuidor:</strong>
                            <span class="ml-2">Puede seleccionar entre direcciones de entrega existentes o crear una nueva.</span>
                        </div>
                        <div class="mt-1 d-flex align-items-center">
                            <field name="use_alternative_delivery" class="mr-2"/>
                            <label for="use_alternative_delivery" string="Usar Direcci贸n de Entrega Alternativa"/>
                        </div>
                        <div class="mt-1 text-muted">
                            <small>Los cambios se guardan autom谩ticamente y se registran en el historial.</small>
                        </div>
                        <!-- Selector de direcciones existentes -->
                        <div class="mt-2" invisible="not use_alternative_delivery">
                            <label for="selected_delivery_partner_id" string="Direcci贸n de Entrega" class="oe_inline"/>
                            <div class="d-flex align-items-center mt-1">
                                <field name="selected_delivery_partner_id"
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       placeholder="Seleccionar direcci贸n de entrega..."
                                       class="w-75"/>
                                <button name="action_create_delivery_address"
                                        string="Nueva direcci贸n" type="object"
                                        class="btn btn-sm btn-primary ml-2"
                                        invisible="not partner_id"
                                        groups="sales_team.group_sale_salesman"/>
                            </div>
                        </div>
                    </div>

                    <!-- Bloque de edici贸n de direcci贸n con dise帽o mejorado -->
                    <fieldset class="mt-3 p-3 border rounded delivery-address-fieldset"
                              invisible="not partner_id">
                        <legend class="text-primary w-auto">
                            <span class="mr-1"></span>
                            <span>Detalles de Direcci贸n de Entrega</span>
                        </legend>

                        <!-- Primera fila: datos de contacto -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="fa fa-user mr-1"></i> Datos de Contacto
                            </h6>
                            <div class="row">
                                <div class="col-lg-6 col-md-12 mb-2">
                                    <label for="delivery_phone" string="Tel茅fono de Contacto"/>
                                    <field name="delivery_phone" placeholder="+34 999 888 777"
                                           widget="phone"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-12 mb-2">
                                    <label for="delivery_email" string="Email de Contacto"/>
                                    <field name="delivery_email" placeholder="contacto@ejemplo.com"
                                           widget="email"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                        </div>

                        <!-- Segunda fila: direcci贸n f铆sica -->
                        <div>
                            <h6 class="text-muted mb-2">
                                <i class="fa fa-map-marker mr-1"></i> Direcci贸n F铆sica
                            </h6>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label for="delivery_street" string="Direcci贸n"/>
                                    <field name="delivery_street" placeholder="Calle y n煤mero"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label for="delivery_street2" string="Informaci贸n Adicional"/>
                                    <field name="delivery_street2" placeholder="Edificio, piso, puerta..."
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_city" string="Ciudad/Localidad"/>
                                    <field name="delivery_city" placeholder="Ciudad"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_zip" string="C贸digo Postal"/>
                                    <field name="delivery_zip" placeholder="CP"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_state_id" string="Provincia"/>
                                    <field name="delivery_state_id" placeholder="Provincia"
                                           options="{'no_create': True}"
                                           context="{'country_id': delivery_country_id}"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                                <div class="col-lg-6 col-md-6 mb-2">
                                    <label for="delivery_country_id" string="Pa铆s"/>
                                    <field name="delivery_country_id" placeholder="Pa铆s"
                                           options="{'no_create': True}"
                                           readonly="state in ('sale', 'done')"/>
                                </div>
                            </div>
                        </div>

                        <!-- Bot贸n para crear direcci贸n nueva -->
                        <div class="text-right mt-3"
                             invisible="not partner_id or not is_distributor_customer">
                            <button name="action_create_delivery_address"
                                    string="Guardar como nueva direcci贸n"
                                    type="object"
                                    class="btn btn-sm btn-primary"
                                    groups="sales_team.group_sale_salesman"/>
                            <div class="text-muted mt-1">
                                <small>Guarda esta direcci贸n para usarla en futuros pedidos.</small>
                            </div>
                        </div>

                        <!-- Botones para gerentes en pedidos confirmados -->
                        <div class="text-right mt-3"
                             invisible="state not in ('sale', 'done') or not partner_id"
                             groups="sales_team.group_sale_manager">
                            <button name="action_create_delivery_address"
                                    string="Modificar direcci贸n de entrega"
                                    type="object"
                                    class="btn btn-sm btn-warning"/>
                            <div class="text-muted mt-1">
                                <small>Como gerente, puede modificar la direcci贸n incluso en pedidos confirmados.</small>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Advertencia de direcci贸n modificada despu茅s de confirmaci贸n -->
                    <div class="alert alert-warning mt-2"
                         invisible="not delivery_address_modified"
                         role="alert">
                        <strong>Atenci贸n:</strong> Esta direcci贸n ha sido modificada despu茅s de confirmar el pedido.
                        Aseg煤rese de que el departamento de log铆stica est谩 informado de los cambios.
                    </div>
                </div>
            </xpath>

            <!-- A帽adir campos en la vista de 谩rbol (lista) de pedidos -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="is_distributor_customer" optional="hide"/>
            </xpath>

            <xpath expr="//field[@name='partner_shipping_id']" position="after">
                <field name="delivery_city" string="Ciudad Entrega" optional="show"/>
                <field name="delivery_phone" string="Tel茅fono Entrega" optional="hide"/>
                <field name="delivery_email" string="Email Entrega" optional="hide"/>
            </xpath>

        </field>
    </record>

    <!-- Mejoras en la vista de b煤squeda de pedidos -->
    <record id="view_sales_order_filter_delivery" model="ir.ui.view">
        <field name="name">sale.order.filter.delivery</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="delivery_city"/>
                <separator/>
                <filter string="Solo Distribuidores" name="distributor_orders"
                        domain="[('is_distributor_customer', '=', True)]"/>
                <filter string="Con Entrega Alternativa" name="alt_delivery"
                        domain="[('use_alternative_delivery', '=', True)]"/>
                <filter string="Direcci贸n Modificada" name="modified_address"
                        domain="[('delivery_address_modified', '=', True)]"/>
            </xpath>

            <xpath expr="//group/filter[@name='customer']" position="after">
                <filter string="Ciudad de Entrega" name="city_groupby" context="{'group_by': 'delivery_city'}"/>
                <filter string="Tipo de Entrega" name="delivery_type_groupby"
                        context="{'group_by': 'use_alternative_delivery'}"/>
            </xpath>
        </field>
    </record>
</odoo>
