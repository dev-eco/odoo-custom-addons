<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario para documento escaneado -->
    <record id="view_document_scan_form" model="ir.ui.view">
        <field name="name">document.scan.form</field>
        <field name="model">document.scan</field>
        <field name="arch" type="xml">
            <form string="Documento Escaneado">
                <header>
                    <button name="action_process" string="Procesar" type="object" class="oe_highlight" invisible="status not in ['pending', 'error']"/>
                    <button name="action_reset" string="Reiniciar" type="object" invisible="status in ['pending']"/>
                    <button name="action_force_manual" string="Marcar para Revisión Manual" type="object" invisible="status == 'manual'"/>
                    <field name="status" widget="statusbar" statusbar_visible="pending,processing,done,manual,error"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_result" type="object" class="oe_stat_button" icon="fa-file-text-o" invisible="result_record_id == False">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Documento</span>
                                <span class="o_stat_text">Final</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nombre del documento"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="document_type_id"/>
                            <field name="document_type_code" invisible="1"/>
                            <field name="source"/>
                            <field name="user_id"/>
                            <field name="create_date" string="Fecha de recepción"/>
                        </group>
                        <group>
                            <field name="processed_date"/>
                            <field name="processing_time" widget="float_time"/>
                            <field name="confidence_score" widget="percentage"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="attachment_id" invisible="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Vista previa">
                            <group>
                                <field name="document_preview" widget="pdf_viewer" filename="name" readonly="1" attrs="{'invisible': [('document_preview', '=', False)]}"/>
                            </group>
                        </page>
                        <page string="Texto OCR">
                            <field name="ocr_text" attrs="{'readonly': True}"/>
                        </page>
                        <page string="Datos extraídos">
                            <field name="ocr_data" attrs="{'readonly': True}"/>
                        </page>
                        <page string="Metadatos">
                            <field name="metadata" attrs="{'readonly': True}"/>
                        </page>
                        <page string="Resultado">
                            <group>
                                <field name="result_model"/>
                                <field name="result_record_id"/>
                                <field name="result_url" widget="url"/>
                            </group>
                        </page>
                        <page string="Notas">
                            <field name="notes"/>
                        </page>
                        <page string="Logs">
                            <field name="log_ids" readonly="1">
                                <tree>
                                    <field name="create_date"/>
                                    <field name="type"/>
                                    <field name="description"/>
                                    <field name="user_id"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>
    
    <!-- Vista árbol para documento escaneado -->
    <record id="view_document_scan_tree" model="ir.ui.view">
        <field name="name">document.scan.tree</field>
        <field name="model">document.scan</field>
        <field name="arch" type="xml">
            <tree string="Documentos Escaneados" decoration-info="status == 'pending'" decoration-warning="status in ['processing', 'manual']" decoration-success="status in ['done', 'processed']" decoration-danger="status == 'error'">
                <field name="name"/>
                <field name="document_type_id"/>
                <field name="create_date" string="Fecha recepción"/>
                <field name="user_id"/>
                <field name="source"/>
                <field name="status"/>
                <field name="processed_date"/>
                <field name="confidence_score" widget="percentage"/>
                <field name="result_model"/>
            </tree>
        </field>
    </record>
    
    <!-- Vista búsqueda para documento escaneado -->
    <record id="view_document_scan_search" model="ir.ui.view">
        <field name="name">document.scan.search</field>
        <field name="model">document.scan</field>
        <field name="arch" type="xml">
            <search string="Buscar Documentos">
                <field name="name"/>
                <field name="document_type_id"/>
                <field name="user_id"/>
                <field name="ocr_text"/>
                <separator/>
                <filter string="Pendientes" name="pending" domain="[('status', '=', 'pending')]"/>
                <filter string="En proceso" name="processing" domain="[('status', '=', 'processing')]"/>
                <filter string="Completados" name="done" domain="[('status', 'in', ['done', 'processed'])]"/>
                <filter string="Revisión Manual" name="manual" domain="[('status', '=', 'manual')]"/>
                <filter string="Con errores" name="error" domain="[('status', '=', 'error')]"/>
                <separator/>
                <filter string="Mis documentos" name="my_documents" domain="[('user_id', '=', uid)]"/>
                <separator/>
                <filter string="Escáner Local" name="scanner" domain="[('source', '=', 'scanner')]"/>
                <filter string="Correo Electrónico" name="email" domain="[('source', '=', 'email')]"/>
                <filter string="API" name="api" domain="[('source', '=', 'api')]"/>
                <group expand="0" string="Agrupar por">
                    <filter string="Tipo de documento" name="group_by_type" context="{'group_by': 'document_type_id'}"/>
                    <filter string="Estado" name="group_by_status" context="{'group_by': 'status'}"/>
                    <filter string="Fuente" name="group_by_source" context="{'group_by': 'source'}"/>
                    <filter string="Usuario" name="group_by_user" context="{'group_by': 'user_id'}"/>
                    <filter string="Mes" name="group_by_month" context="{'group_by': 'create_date:month'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Acción para abrir documentos escaneados -->
    <record id="action_document_scan" model="ir.actions.act_window">
        <field name="name">Documentos Escaneados</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">document.scan</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay documentos escaneados aún
            </p>
            <p>
                Aquí se mostrarán los documentos escaneados y procesados.
            </p>
        </field>
    </record>
    
    <!-- Vista de kanban para documentos escaneados -->
    <record id="view_document_scan_kanban" model="ir.ui.view">
        <field name="name">document.scan.kanban</field>
        <field name="model">document.scan</field>
        <field name="arch" type="xml">
            <kanban string="Documentos" class="o_document_kanban">
                <field name="id"/>
                <field name="name"/>
                <field name="document_type_id"/>
                <field name="status"/>
                <field name="confidence_score"/>
                <field name="document_preview"/>
                <field name="user_id"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill o_document_kanban_card">
                            <div class="o_kanban_image_fill_left" t-attf-style="background-image: url(#{record.document_preview.value});"/>
                            <div class="oe_kanban_details">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                                <div>
                                    <field name="document_type_id"/>
                                </div>
                                <div>
                                    <field name="status" widget="label_selection" options="{'classes': {'pending': 'primary', 'processing': 'warning', 'done': 'success', 'processed': 'success', 'manual': 'info', 'error': 'danger'}}"/>
                                </div>
                                <div t-if="record.confidence_score.raw_value > 0">
                                    <span>Confianza: </span>
                                    <field name="confidence_score" widget="percentage"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- Vista formulario para tipo de documento -->
    <record id="view_document_type_form" model="ir.ui.view">
        <field name="name">document.type.form</field>
        <field name="model">document.type</field>
        <field name="arch" type="xml">
            <form string="Tipo de Documento">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_documents" type="object" class="oe_stat_button" icon="fa-file-text-o">
                            <field name="document_count" string="Documentos" widget="statinfo"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" placeholder="Nombre del tipo de documento"/>
                        </h1>
                        <label for="code" class="oe_edit_only"/>
                        <h3>
                            <field name="code" placeholder="Código único"/>
                        </h3>
                    </div>
                    <group>
                        <group>
                            <field name="sequence" widget="handle"/>
                            <field name="active" widget="boolean_toggle"/>
                            <field name="target_model"/>
                        </group>
                        <group>
                            <field name="success_rate" widget="percentage"/>
                            <field name="avg_confidence" widget="percentage"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Descripción">
                            <field name="description" placeholder="Descripción del tipo de documento y su procesamiento..."/>
                        </page>
                        <page string="Mapeo de Campos">
                            <button name="action_test_mapping" string="Probar Mapeo" type="object" class="oe_highlight"/>
                            <field name="field_mappings" placeholder="Mapeo de campos en formato JSON..."/>
                        </page>
                        <page string="Valores por Defecto">
                            <field name="target_model_defaults" placeholder="Valores por defecto en formato JSON..."/>
                        </page>
                        <page string="Plantilla OCR">
                            <field name="ocr_template" placeholder="Plantilla OCR para este tipo de documento..."/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Vista árbol para tipo de documento -->
    <record id="view_document_type_tree" model="ir.ui.view">
        <field name="name">document.type.tree</field>
        <field name="model">document.type</field>
        <field name="arch" type="xml">
            <tree string="Tipos de Documento">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="code"/>
                <field name="target_model"/>
                <field name="document_count"/>
                <field name="success_rate" widget="percentage"/>
                <field name="active" widget="boolean_toggle"/>
            </tree>
        </field>
    </record>
    
    <!-- Acción para abrir tipos de documento -->
    <record id="action_document_type" model="ir.actions.act_window">
        <field name="name">Tipos de Documento</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">document.type</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crea tu primer tipo de documento
            </p>
            <p>
                Los tipos de documento definen cómo se procesan diferentes documentos en el sistema.
            </p>
        </field>
    </record>
    
    <!-- Vista formulario para log de documento -->
    <record id="view_document_scan_log_form" model="ir.ui.view">
        <field name="name">document.scan.log.form</field>
        <field name="model">document.scan.log</field>
        <field name="arch" type="xml">
            <form string="Log de Documento">
                <sheet>
                    <group>
                        <group>
                            <field name="document_id"/>
                            <field name="type"/>
                            <field name="action"/>
                        </group>
                        <group>
                            <field name="create_date" readonly="1"/>
                            <field name="user_id" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Descripción">
                            <field name="description"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Vista árbol para log de documento -->
    <record id="view_document_scan_log_tree" model="ir.ui.view">
        <field name="name">document.scan.log.tree</field>
        <field name="model">document.scan.log</field>
        <field name="arch" type="xml">
            <tree string="Logs de Documento" decoration-info="type == 'info'" decoration-warning="type == 'warning'" decoration-success="type == 'success'" decoration-danger="type == 'error'">
                <field name="create_date"/>
                <field name="document_id"/>
                <field name="type"/>
                <field name="description"/>
                <field name="user_id"/>
            </tree>
        </field>
    </record>
    
    <!-- Acción para abrir logs de documento -->
    <record id="action_document_scan_log" model="ir.actions.act_window">
        <field name="name">Logs de Procesamiento</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">document.scan.log</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay logs de procesamiento aún
            </p>
            <p>
                Aquí se mostrarán los logs del procesamiento de documentos.
            </p>
        </field>
    </record>
</odoo>
