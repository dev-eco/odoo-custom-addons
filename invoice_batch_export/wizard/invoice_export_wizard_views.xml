<?xml version="1.0" encoding="utf-8"?>
<!--
    Vistas del Wizard de Exportación Masiva

    Este archivo define todas las vistas XML que conforman la interfaz de usuario
    del wizard de exportación. En Odoo, las vistas XML son los "moldes" que
    transforman los datos de los modelos Python en interfaces web interactivas.

    ¿Cómo Funciona la Arquitectura Vista-Modelo en Odoo?
    ====================================================
    Imagina que los modelos Python son como los "datos en bruto" y las vistas XML
    son como "plantillas de presentación". El navegador web nunca ve directamente
    los modelos Python; en su lugar, Odoo usa las vistas XML para generar HTML, CSS
    y JavaScript que el navegador puede renderizar.

    Esta separación es muy poderosa porque:
    1. Los datos (Python) están separados de la presentación (XML)
    2. Múltiples vistas pueden mostrar los mismos datos de diferentes formas
    3. Las vistas se pueden personalizar sin tocar la lógica de negocio
    4. Odoo puede optimizar la generación de UI automáticamente

    Evolución de Sintaxis: Odoo 16 vs Odoo 17
    ==========================================
    Una de las mejoras más significativas en Odoo 17 es la simplificación
    de la sintaxis de vistas. Donde antes necesitábamos escribir:

    Odoo 16 (sintaxis antigua):
    attrs="{'invisible': [('campo', '=', valor)]}"

    Odoo 17 (sintaxis nueva):
    invisible="campo == valor"

    Esta nueva sintaxis es:
    - Más fácil de leer y escribir
    - Menos propensa a errores de sintaxis
    - Más similar a JavaScript moderno
    - Mejor rendimiento en el navegador

    En este archivo usaremos exclusivamente la sintaxis de Odoo 17 para
    demostrar las mejores prácticas actuales.
-->

<odoo>
    <!--
        VISTA PRINCIPAL DEL WIZARD - FORMULARIO INTERACTIVO
        ==================================================
        
        Esta vista implementa el formulario principal del wizard, diseñado
        para guiar al usuario a través del proceso de configuración y
        exportación de facturas.
        
        El diseño sigue el patrón "Progressive Disclosure": mostramos
        información básica primero, y revelamos opciones avanzadas según
        las necesidades del usuario.
    -->
    <record id="view_batch_export_wizard_form" model="ir.ui.view">
        <field name="name">batch.export.wizard.form</field>
        <field name="model">batch.export.wizard</field>
        <field name="arch" type="xml">
            <form string="Exportación Masiva de Facturas">
                <!--
                    ESTADO DEL WIZARD: CONFIGURACIÓN vs RESULTADO
                    =============================================
                    
                    El wizard tiene dos "estados" principales:
                    1. Configuración: Antes de ejecutar la exportación
                    2. Resultado: Después de completar la exportación
                    
                    Usamos el campo 'export_file' como indicador de estado:
                    - Si export_file está vacío = estado de configuración
                    - Si export_file tiene valor = estado de resultado
                    
                    Esta técnica permite que la misma vista XML sirva para
                    ambos propósitos, proporcionando una experiencia fluida
                    sin necesidad de múltiples vistas.
                -->
                
                <!-- =============================================== -->
                <!-- SECCIÓN 1: CONFIGURACIÓN (antes de exportar)   -->
                <!-- =============================================== -->
                <group name="configuration_section" invisible="export_file">
                    <!--
                        CONFIGURACIÓN PRINCIPAL
                        =====================
                        
                        Esta sección contiene los controles principales que
                        todo usuario necesita configurar para realizar una
                        exportación exitosa.
                    -->
                    <group string="🏢 Configuración Principal" colspan="4">
                        <group>
                            <!--
                                Campo de Empresa con Widget de Selección
                                =======================================
                                
                                widget="selection": Muestra empresas como dropdown
                                en lugar de campo de búsqueda. Mejor UX cuando hay
                                pocas empresas (caso típico en instalaciones PyME).
                            -->
                            <field name="company_id" 
                                   widget="selection"
                                   options="{'no_create': True, 'no_open': True}"/>
                            
                            <!--
                                Plantilla con Domain Dinámico
                                ============================
                                
                                domain="[('company_id', '=', company_id), ('active', '=', True)]"
                                
                                Este domain se evalúa dinámicamente en el navegador,
                                filtrando las plantillas según la empresa seleccionada.
                                Es un ejemplo perfecto de cómo Odoo hace la interfaz
                                reactiva sin necesidad de JavaScript personalizado.
                            -->
                            <field name="export_template_id"
                                   domain="[('company_id', '=', company_id), ('active', '=', True)]"
                                   context="{'default_company_id': company_id}"
                                   options="{'no_create_edit': True}"/>
                        </group>
                        
                        <group>
                            <!--
                                Formato de Compresión con Widget Radio
                                =====================================
                                
                                widget="radio": Muestra todas las opciones visibles
                                simultáneamente. Mejor para 2-5 opciones donde el
                                usuario necesita ver todas las alternativas.
                                
                                El método _get_available_compression_formats() en
                                el modelo Python controla qué opciones aparecen.
                            -->
                            <field name="compression_format" 
                                   widget="radio"
                                   class="o_horizontal"/>
                            
                            <!--
                                Tamaño de Lote con Validación Visual
                                ===================================
                                
                                Este campo incluye ayuda contextual que explica
                                el impacto de diferentes valores en el rendimiento.
                            -->
                            <field name="batch_size"/>
                        </group>
                    </group>
                    
                    <!--
                        FILTROS DE DOCUMENTOS
                        ====================
                        
                        Esta sección permite al usuario especificar exactamente
                        qué tipos de documentos quiere incluir en la exportación.
                    -->
                    <group string="📄 Tipos de Documentos" colspan="4">
                        <group>
                            <!--
                                Checkboxes Booleanos para Filtros
                                ================================
                                
                                Los campos booleanos se renderizan automáticamente
                                como checkboxes, proporcionando una interfaz
                                intuitiva para opciones de sí/no.
                            -->
                            <field name="include_customer_invoices"/>
                            <field name="include_vendor_bills"/>
                            <field name="include_credit_notes"/>
                        </group>
                        
                        <group>
                            <!--
                                Campo Computed para Vista Previa
                                ===============================
                                
                                Este campo muestra dinámicamente cuántas facturas
                                se exportarán con los filtros actuales, proporcionando
                                feedback inmediato al usuario.
                            -->
                            <field name="estimated_invoice_count" 
                                   readonly="1"
                                   class="oe_inline"
                                   string="Facturas estimadas"/>
                        </group>
                    </group>
                    
                    <!--
                        FILTROS DE FECHA Y ESTADO
                        ========================
                        
                        Controles para refinar temporalmente qué facturas incluir.
                    -->
                    <group string="📅 Filtros de Fecha y Estado" colspan="4">
                        <group>
                            <!--
                                Campos de Fecha con Widget Calendar
                                ==================================
                                
                                widget="date": Proporciona selector de calendario
                                visual. Mejor UX que campos de texto plano.
                            -->
                            <field name="date_from" widget="date"/>
                            <field name="date_to" widget="date"/>
                        </group>
                        
                        <group>
                            <!--
                                Estado con Widget Radio Horizontal
                                =================================
                                
                                class="o_horizontal": Disposición horizontal
                                para opciones radio, ahorrando espacio vertical.
                            -->
                            <field name="state_filter" 
                                   widget="radio"
                                   class="o_horizontal"/>
                        </group>
                    </group>
                    
                    <!--
                        FACTURAS PRESELECCIONADAS (CONDICIONAL)
                        ======================================
                        
                        Esta sección solo aparece cuando el usuario ha seleccionado
                        facturas específicas antes de abrir el wizard.
                        
                        invisible="not invoice_ids": Se oculta cuando la lista
                        de facturas preseleccionadas está vacía.
                    -->
                    <group string="📋 Facturas Preseleccionadas" 
                           colspan="4" 
                           invisible="not invoice_ids">
                        
                        <!--
                            Tree View Embebida para Facturas
                            ===============================
                            
                            Esta es una vista de lista embebida dentro del formulario
                            del wizard. Permite al usuario ver y refinar la selección
                            de facturas sin salir del contexto actual.
                        -->
                        <field name="invoice_ids" nolabel="1" colspan="4">
                            <tree string="Facturas Seleccionadas" 
                                  create="false" 
                                  edit="false"
                                  delete="true">
                                <!--
                                    create="false": No permite crear facturas desde aquí
                                    edit="false": No permite editar facturas en línea
                                    delete="true": Permite quitar facturas de la selección
                                    
                                    Esta configuración tiene sentido: el usuario puede
                                    refinar su selección quitando facturas, pero no
                                    debería crear o editar facturas desde el wizard.
                                -->
                                
                                <field name="name" string="Número"/>
                                <field name="partner_id" string="Cliente/Proveedor"/>
                                <field name="invoice_date" string="Fecha"/>
                                <field name="amount_total" string="Total" 
                                       widget="monetary"/>
                                <field name="state" string="Estado"/>
                                
                                <!--
                                    Campo de Empresa Solo en Multi-Empresa
                                    ====================================
                                    
                                    groups="base.group_multi_company": Solo muestra
                                    este campo si el usuario pertenece al grupo de
                                    usuarios multi-empresa. Reduce saturación visual
                                    en instalaciones de empresa única.
                                -->
                                <field name="company_id" 
                                       string="Empresa"
                                       groups="base.group_multi_company"/>
                            </tree>
                        </field>
                        
                        <!--
                            Nota Informativa con Estilos Bootstrap
                            ====================================
                            
                            Odoo incluye Bootstrap CSS, permitiendo usar clases
                            como 'alert' para crear mensajes informativos visualmente
                            consistentes con el resto del sistema.
                        -->
                        <div class="alert alert-info" role="alert" colspan="4">
                            <strong>💡 Consejo:</strong> Puede quitar facturas específicas 
                            de la selección usando el botón ❌ en cada fila. Las facturas 
                            quitadas no se incluirán en la exportación.
                        </div>
                    </group>
                    
                    <!--
                        NOTA INFORMATIVA GENERAL
                        =======================
                        
                        Proporciona orientación al usuario sobre el comportamiento
                        del sistema cuando no hay facturas preseleccionadas.
                    -->
                    <group colspan="4" invisible="invoice_ids">
                        <div class="alert alert-info" role="alert">
                            <strong>ℹ️ Información:</strong> Como no hay facturas 
                            preseleccionadas, se exportarán todas las facturas que 
                            cumplan los filtros configurados arriba.
                            <br/><br/>
                            <strong>📝 Formato de nombres:</strong> Los archivos se 
                            nombrarán según la plantilla seleccionada o usando el formato: 
                            <code>[TIPO]_[NÚMERO]_[CLIENTE]_[FECHA].pdf</code>
                        </div>
                    </group>
                </group>
                
                <!-- =============================================== -->
                <!-- SECCIÓN 2: RESULTADOS (después de exportar)    -->
                <!-- =============================================== -->
                <group name="results_section" invisible="not export_file">
                    <!--
                        MÉTRICAS DE EXPORTACIÓN
                        ======================
                        
                        Muestra estadísticas detalladas sobre la exportación
                        completada, incluyendo rendimiento y calidad.
                    -->
                    <group string="📊 Resultados de Exportación" colspan="4">
                        <group>
                            <!--
                                Contador de Facturas Exportadas
                                ===============================
                                
                                readonly="1": Campo de solo lectura en Odoo 17
                                (más limpio que la sintaxis anterior con attrs)
                            -->
                            <field name="export_count" 
                                   readonly="1"
                                   class="o_stat_info"/>
                            
                            <!--
                                Contador de Errores (Condicional)
                                ================================
                                
                                invisible="not failed_count": Solo muestra este
                                campo si hubo facturas que fallaron, evitando
                                confusión cuando todo sale bien.
                            -->
                            <field name="failed_count" 
                                   readonly="1"
                                   class="o_stat_info"
                                   invisible="not failed_count"/>
                        </group>
                        
                        <group>
                            <!--
                                Métricas de Rendimiento
                                ======================
                                
                                widget="percentage": Formatea automáticamente
                                el valor como porcentaje (0.75 → 75%)
                            -->
                            <field name="compression_ratio" 
                                   readonly="1"
                                   widget="percentage"/>
                            
                            <field name="processing_time" 
                                   readonly="1"
                                   string="Tiempo (segundos)"/>
                        </group>
                        
                        <!--
                            DESCARGA DEL ARCHIVO
                            ===================
                            
                            Esta es la funcionalidad principal: permitir al usuario
                            descargar el archivo generado.
                        -->
                        <group colspan="4">
                            <!--
                                Campo Binario con Nombre de Archivo
                                ==================================
                                
                                filename="export_filename": Usa el valor del campo
                                export_filename como nombre sugerido para la descarga.
                                
                                El campo export_filename debe existir pero puede estar
                                oculto (invisible="1") ya que solo se usa internamente.
                            -->
                            <field name="export_filename" invisible="1"/>
                            <field name="export_file" 
                                   filename="export_filename"
                                   readonly="1"
                                   string="📦 Descargar Archivo de Exportación"
                                   colspan="4"/>
                        </group>
                    </group>
                    
                    <!--
                        MENSAJE DE ÉXITO CON INFORMACIÓN DINÁMICA
                        ========================================
                        
                        Muestra un mensaje de éxito que incluye información
                        específica sobre la exportación realizada.
                    -->
                    <group colspan="4">
                        <div class="alert alert-success" role="alert">
                            <strong>✅ ¡Exportación exitosa!</strong>
                            <br/><br/>
                            Se han exportado exitosamente 
                            <field name="export_count" readonly="1" class="oe_inline"/> 
                            facturas con una compresión de 
                            <field name="compression_ratio" readonly="1" class="oe_inline" widget="percentage"/>.
                            <br/><br/>
                            <!--
                                Mensaje Condicional para Errores Parciales
                                ==========================================
                                
                                invisible="not failed_count": Solo muestra información
                                sobre errores si realmente hubo algunos.
                            -->
                            <span invisible="not failed_count">
                                <strong>⚠️ Atención:</strong> 
                                <field name="failed_count" readonly="1" class="oe_inline"/> 
                                facturas no pudieron ser exportadas debido a errores. 
                                Consulte los logs del sistema para más detalles.
                                <br/><br/>
                            </span>
                            
                            <strong>🔽 Haga clic en el enlace de arriba para descargar el archivo.</strong>
                        </div>
                    </group>
                </group>
                
                <!--
                    FOOTER CON BOTONES DE ACCIÓN
                    ===========================
                    
                    El footer contiene los botones que controlan el flujo del wizard.
                    La visibilidad de cada botón depende del estado actual.
                -->
                <footer>
                    <!--
                        BOTÓN DE EXPORTACIÓN
                        ===================
                        
                        Este es el botón principal que inicia todo el proceso.
                        Solo es visible antes de realizar la exportación.
                    -->
                    <button name="action_export_invoices"
                            string="🚀 Iniciar Exportación"
                            type="object"
                            class="btn-primary"
                            invisible="export_file"
                            help="Iniciar el proceso de exportación masiva con la configuración especificada"/>
                    
                    <!--
                        BOTÓN CERRAR (después de exportar)
                        =================================
                        
                        Aparece después de completar la exportación.
                        special="cancel": Cierra el wizard sin ejecutar código adicional.
                    -->
                    <button string="✅ Cerrar"
                            special="cancel"
                            class="btn-secondary"
                            invisible="not export_file"
                            help="Cerrar el wizard de exportación"/>
                    
                    <!--
                        BOTÓN CANCELAR (antes de exportar)
                        =================================
                        
                        Permite cancelar el proceso antes de iniciarlo.
                        Aparece en la misma posición que "Cerrar" pero con
                        texto diferente para reflejar el contexto.
                    -->
                    <button string="❌ Cancelar"
                            special="cancel"
                            class="btn-secondary"
                            invisible="export_file"
                            help="Cancelar y cerrar sin realizar exportación"/>
                </footer>
            </form>
        </field>
    </record>
    
    <!--
        ACCIÓN PRINCIPAL DEL WIZARD
        ==========================
        
        Define cómo se abre y comporta el wizard cuando es invocado.
        Esta acción conecta el modelo Python con la vista XML.
    -->
    <record id="action_batch_export_wizard" model="ir.actions.act_window">
        <field name="name">Exportación Masiva de Facturas</field>
        <field name="res_model">batch.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <!--
            target="new": Abre en ventana modal (overlay)
            
            Alternativas:
            - target="current": Reemplaza la vista actual
            - target="fullscreen": Pantalla completa
            - target="main": Ventana principal (raro)
            
            Para wizards, "new" (modal) es casi siempre la opción correcta
            porque mantiene el contexto de dónde vino el usuario.
        -->
        
        <!--
            BINDING DE LA ACCIÓN
            ===================
            
            Estos campos hacen que la acción aparezca automáticamente
            en el menú "Acción" cuando el usuario selecciona facturas.
        -->
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        <!--
            binding_view_types="list": Solo aparece en vista de lista
            
            Otras opciones:
            - "form": Solo en vista de formulario
            - "list,form": En ambas vistas
            - Sin especificar: En todas las vistas
            
            Para exportación masiva, "list" tiene sentido porque
            necesitas seleccionar múltiples registros.
        -->
        
        <!--
            CONFIGURACIÓN ADICIONAL DE LA ACCIÓN
            ===================================
        -->
        <field name="help">
            <![CDATA[
                <p class="o_view_nocontent_smiling_face">
                    Exportación Masiva de Facturas
                </p>
                <p>
                    Seleccione facturas de la lista y use el botón "Acción" 
                    para acceder a la exportación masiva, o abra este wizard 
                    directamente para configurar filtros personalizados.
                </p>
            ]]>
        </field>
    </record>
    
    <!--
        ÍTEM DE MENÚ PRINCIPAL
        =====================
        
        Añade un enlace directo al wizard en el menú de contabilidad.
        Esto permite acceder al wizard sin necesidad de seleccionar facturas.
    -->
    <menuitem id="menu_batch_export_wizard"
              name="Exportación Masiva"
              parent="account.menu_finance_reports"
              action="action_batch_export_wizard"
              sequence="85"
              groups="account.group_account_user"/>
    <!--
        sequence="85": Controla la posición en el menú
        - Números bajos aparecen primero
        - Números altos aparecen al final
        - 85 coloca el ítem hacia el final pero antes de ítems de configuración
        
        groups="account.group_account_user": Solo visible para usuarios
        con permisos de contabilidad. Esto tiene sentido porque las facturas
        son datos contables sensibles.
    -->

</odoo>

<!--
    CONCEPTOS AVANZADOS DE VISTAS EN ODOO
    ====================================
    
    Progressive Disclosure (Revelación Progresiva)
    ---------------------------------------------
    Este wizard implementa el principio de Progressive Disclosure:
    - Muestra información esencial primero
    - Revela detalles según las necesidades del usuario
    - Oculta complejidad innecesaria hasta que sea relevante
    
    Esto mejora la usabilidad porque:
    - Reduce la carga cognitiva inicial
    - Permite workflows tanto simples como avanzados
    - Evita saturación visual de la interfaz
    
    Reactive UI sin JavaScript Personalizado
    ---------------------------------------
    Odoo proporciona reactividad automática a través de:
    - Domains dinámicos: Filtros que cambian según otros campos
    - Campos computed: Información que se actualiza automáticamente
    - Visibilidad condicional: Elementos que aparecen/desaparecen
    - Validación en tiempo real: Feedback inmediato sobre errores
    
    Esto elimina la necesidad de escribir JavaScript personalizado
    para la mayoría de casos de uso comunes.
    
    Consistencia Visual con el Core de Odoo
    --------------------------------------
    Al usar las clases CSS y patrones de Odoo (alert, btn-primary, etc.)
    garantizamos que nuestra interfaz:
    - Se vea nativa, no como un plugin externo
    - Funcione correctamente en todos los dispositivos
    - Sea accesible para usuarios con discapacidades
    - Se beneficie automáticamente de mejoras futuras en el core
    
    Separación de Responsabilidades
    ------------------------------
    La clara separación entre:
    - Modelo (batch_export_wizard.py): Lógica de negocio
    - Vista (este archivo): Presentación e interacción
    - Acción (records en este archivo): Navegación y contexto
    
    Facilita el mantenimiento y permite que diferentes desarrolladores
    trabajen en diferentes aspectos sin conflictos.
    
    Internacionalización Automática
    ------------------------------
    Al usar la función _() en strings y mantener textos en español
    en las vistas, facilitamos la traducción automática. Odoo puede
    extraer todos estos strings y generar archivos de traducción
    automáticamente.
    
    Accesibilidad Web
    ----------------
    El uso de elementos como:
    - role="alert" para mensajes importantes
    - Etiquetas descriptivas en todos los campos
    - Estructura semántica apropiada (groups, headers)
    - Texto alternativo para iconos emoji
    
    Garantiza que la interfaz sea accesible para usuarios que usan
    lectores de pantalla u otras tecnologías de asistencia.
-->
