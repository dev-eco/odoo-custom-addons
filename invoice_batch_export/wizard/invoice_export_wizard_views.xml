<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- 
        VISTA DE FORMULARIO DEL WIZARD - PASO 1: CONFIGURACIÓN
        
        Esta vista se muestra cuando el usuario abre el wizard por primera vez.
        Permite configurar qué facturas exportar y con qué criterios.
        
        ACTUALIZADO PARA ODOO 17.0
        ==========================
        - Eliminado el uso de attrs (deprecado en Odoo 17)
        - Reemplazado por invisible, readonly, required directos
        - Sintaxis más limpia y legible
        - Mejor rendimiento en el navegador
    -->
    <record id="view_invoice_export_wizard_form" model="ir.ui.view">
        <field name="name">invoice.export.wizard.form</field>
        <field name="model">invoice.export.wizard</field>
        <field name="arch" type="xml">
            <form string="Exportar Facturas a ZIP">
                <!-- 
                    Visibilidad condicional en Odoo 17
                    ===================================
                    
                    Sintaxis antigua (≤ Odoo 16):
                    attrs="{'invisible': [('zip_file', '!=', False)]}"
                    
                    Sintaxis nueva (≥ Odoo 17):
                    invisible="zip_file"
                    
                    Explicación de la lógica:
                    - "zip_file" se evalúa como True cuando el campo tiene valor
                    - "zip_file" se evalúa como False cuando el campo está vacío
                    - "not zip_file" invierte la lógica
                    
                    Por lo tanto:
                    - invisible="zip_file" = ocultar cuando zip_file tiene valor
                    - invisible="not zip_file" = ocultar cuando zip_file está vacío
                -->
                
                <!-- SECCIÓN 1: CONFIGURACIÓN (visible antes de exportar) -->
                <group name="config_group" invisible="zip_file">
                    <group string="Filtros de Exportación" colspan="4">
                        <!-- 
                            Separadores ayudan a organizar visualmente
                            No necesitan atributos de visibilidad porque son estáticos
                        -->
                        <separator string="Tipos de Documento" colspan="2"/>
                        <group colspan="2">
                            <!-- 
                                Checkboxes booleanos para seleccionar tipos de facturas
                                
                                Estos campos no necesitan atributos condicionales porque
                                siempre deben ser visibles y editables en la configuración
                            -->
                            <field name="include_customer_invoices"/>
                            <field name="include_vendor_bills"/>
                        </group>
                        
                        <separator string="Rango de Fechas (Opcional)" colspan="2"/>
                        <group colspan="2">
                            <!-- 
                                Campos de fecha con widget especial
                                
                                widget="date" proporciona un selector de calendario visual
                                Mejora la experiencia de usuario y previene errores de formato
                            -->
                            <field name="date_from" widget="date"/>
                            <field name="date_to" widget="date"/>
                        </group>
                        
                        <separator string="Estado de las Facturas" colspan="2"/>
                        <group colspan="2">
                            <!-- 
                                Selection field con widget de radio buttons
                                
                                widget="radio" muestra todas las opciones visible
                                Mejor UX para 2-4 opciones vs un dropdown
                            -->
                            <field name="state" widget="radio"/>
                        </group>
                        
                        <!-- 
                            Separador y grupo condicionales para facturas preseleccionadas
                            
                            Sintaxis Odoo 17 para listas vacías:
                            - invoice_ids es un Many2many field
                            - Se evalúa como False cuando la lista está vacía
                            - Se evalúa como True cuando tiene elementos
                            
                            Por lo tanto:
                            - invisible="not invoice_ids" = ocultar si lista vacía
                        -->
                        <separator string="Facturas Preseleccionadas" colspan="2" 
                                   invisible="not invoice_ids"/>
                        <group colspan="2" invisible="not invoice_ids">
                            <!-- 
                                Campo Many2many con tree view embebida
                                
                                Muestra las facturas que el usuario seleccionó previamente
                                desde la vista de lista antes de abrir el wizard.
                                
                                nolabel="1": No muestra etiqueta (el separator ya lo indica)
                                colspan="2": Ocupa las dos columnas disponibles
                            -->
                            <field name="invoice_ids" nolabel="1">
                                <tree string="Facturas" create="false" delete="true">
                                    <!-- 
                                        create="false": Usuario no puede crear facturas desde aquí
                                        delete="true": Usuario puede quitar facturas de la selección
                                        
                                        Esta configuración permite refinar la selección pero no
                                        añadir nuevas facturas (lo cual no tendría sentido aquí)
                                    -->
                                    <field name="name" string="Número"/>
                                    <field name="partner_id" string="Cliente/Proveedor"/>
                                    <field name="invoice_date" string="Fecha"/>
                                    <field name="amount_total" string="Total"/>
                                    <field name="state" string="Estado"/>
                                </tree>
                            </field>
                        </group>
                    </group>
                    
                    <!-- Nota informativa para el usuario usando Bootstrap alerts -->
                    <group colspan="4">
                        <div class="alert alert-info" role="alert">
                            <!-- 
                                Clases Bootstrap en Odoo
                                
                                Odoo incluye Bootstrap CSS por defecto, permitiendo usar:
                                - alert, alert-info (info azul)
                                - alert-warning (advertencia amarilla)
                                - alert-danger (error rojo)
                                - alert-success (éxito verde)
                                
                                Esto mantiene consistencia visual con el resto de Odoo
                            -->
                            <strong>Nota:</strong> Si no seleccionas facturas específicas, 
                            se exportarán todas las facturas que cumplan los filtros configurados.
                            <br/>
                            <strong>Formato de nombres:</strong> Los archivos se nombrarán como: 
                            <code>[TIPO]_[NÚMERO]_[PARTNER]_[FECHA].pdf</code>
                        </div>
                    </group>
                </group>

                <!-- SECCIÓN 2: RESULTADO (visible después de exportar) -->
                <!-- 
                    Lógica de visibilidad invertida:
                    - config_group: invisible="zip_file" (ocultar cuando hay zip)
                    - result_group: invisible="not zip_file" (ocultar cuando no hay zip)
                    
                    Esto crea un efecto de "swap": cuando termina la exportación,
                    la sección de configuración desaparece y la de resultado aparece
                -->
                <group name="result_group" invisible="not zip_file">
                    <group string="Exportación Completada" colspan="4">
                        <!-- 
                            Campo de información con contador de facturas
                            
                            readonly="1" es la sintaxis correcta en Odoo 17
                            Ya no se usa attrs="{'readonly': True}"
                            
                            El "1" es equivalente a True en XML (herencia de HTML)
                        -->
                        <field name="export_count" readonly="1" 
                               string="Facturas Exportadas"/>
                        
                        <!-- 
                            Campo binario para descarga del archivo ZIP
                            
                            Atributos importantes:
                            - filename="zip_filename": Define el nombre de descarga
                            - readonly="1": No editable (es solo para descarga)
                            - invisible="1" para zip_filename: Campo auxiliar oculto
                            
                            El campo zip_filename debe existir y contener el nombre
                            del archivo, pero no necesita ser visible al usuario
                        -->
                        <field name="zip_filename" invisible="1"/>
                        <field name="zip_file" filename="zip_filename" 
                               readonly="1" string="Descargar Archivo ZIP"/>
                    </group>
                    
                    <!-- Mensaje de éxito con estilo Bootstrap -->
                    <group colspan="4">
                        <div class="alert alert-success" role="alert">
                            <!-- 
                                Alert de éxito (verde) para indicar completitud
                                
                                Noticia: En este div podemos embeber fields inline
                                usando class="oe_inline" para que aparezcan dentro
                                del texto sin romper el flujo visual
                            -->
                            <strong>¡Exportación exitosa!</strong><br/>
                            Se han exportado 
                            <field name="export_count" readonly="1" class="oe_inline"/> 
                            facturas en formato ZIP.<br/>
                            Haz clic en el archivo ZIP arriba para descargarlo.
                        </div>
                    </group>
                </group>

                <!-- 
                    FOOTER CON BOTONES
                    
                    El footer contiene los botones de acción del wizard.
                    La visibilidad de botones también usa la nueva sintaxis de Odoo 17.
                -->
                <footer>
                    <!-- 
                        Botón de exportación (visible antes de exportar)
                        
                        Cambio en Odoo 17:
                        Antiguo: attrs="{'invisible': [('zip_file', '!=', False)]}"
                        Nuevo: invisible="zip_file"
                        
                        Lógica:
                        - Cuando zip_file está vacío (False), el botón es visible
                        - Cuando zip_file tiene valor (True), el botón se oculta
                        
                        class="btn-primary": Botón azul destacado (acción principal)
                        type="object": Llama a un método Python del modelo
                        name: Nombre del método a ejecutar
                    -->
                    <button name="action_export_invoices" 
                            string="Exportar Facturas" 
                            type="object" 
                            class="btn-primary"
                            invisible="zip_file"/>
                    
                    <!-- 
                        Botón "Cerrar" (visible después de exportar)
                        
                        special="cancel": Cierra el wizard sin ejecutar nada más
                        class="btn-secondary": Botón gris (acción secundaria)
                        
                        Lógica invertida del botón anterior:
                        - Solo visible cuando zip_file tiene valor
                        - Se oculta antes de la exportación
                    -->
                    <button string="Cerrar" 
                            special="cancel" 
                            class="btn-secondary"
                            invisible="not zip_file"/>
                    
                    <!-- 
                        Botón "Cancelar" (visible antes de exportar)
                        
                        Este botón aparece en la misma posición que "Cerrar"
                        pero con texto diferente para reflejar el estado del wizard:
                        - "Cancelar": Antes de exportar (cancelas la acción)
                        - "Cerrar": Después de exportar (solo cierras el wizard)
                        
                        Este cambio de texto mejora la claridad comunicativa
                    -->
                    <button string="Cancelar" 
                            special="cancel" 
                            class="btn-secondary"
                            invisible="zip_file"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- 
        ACCIÓN DE VENTANA
        
        Define cómo se abre el wizard cuando el usuario lo invoca.
        No requiere cambios para Odoo 17 porque no usa attrs.
        
        Atributos clave:
        - target="new": Abre en modal (ventana overlay)
        - binding_model_id: En qué modelo aparece esta acción
        - binding_view_types: Desde qué vistas está disponible
    -->
    <record id="action_invoice_export_wizard" model="ir.actions.act_window">
        <field name="name">Exportar Facturas a ZIP</field>
        <field name="res_model">invoice.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <!-- 
            target="new" crea un modal overlay:
            - El fondo se oscurece
            - Ventana aparece centrada encima
            - Usuario mantiene contexto de lo que estaba haciendo
            - Ideal para wizards y acciones rápidas
        -->
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        <!-- 
            binding_view_types="list" significa:
            - La acción aparece en la vista de lista de facturas
            - Se accede desde el menú "Acción" al seleccionar facturas
            - No aparece en vista de formulario (no tendría sentido ahí)
        -->
    </record>

    <!-- 
        ÍTEM DE MENÚ
        
        Añade un enlace en el menú principal de Odoo.
        Complementa el binding en la vista de lista.
        
        Ubicación: Contabilidad > Informes > Exportar Facturas
    -->
    <menuitem id="menu_invoice_export_wizard"
              name="Exportar Facturas"
              parent="account.menu_finance_reports"
              action="action_invoice_export_wizard"
              sequence="100"/>
    <!-- 
        sequence="100": Coloca al final de la lista
        - Números bajos (1-10) van al inicio
        - Números altos (90-100) van al final
        - Permite controlar el orden sin modificar otros menús
    -->

</odoo>
