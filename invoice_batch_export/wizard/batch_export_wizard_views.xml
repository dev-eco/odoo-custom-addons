<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        VISTA PRINCIPAL DEL WIZARD DE EXPORTACI√ìN MASIVA
        ==============================================
        
        Esta vista proporciona una interfaz intuitiva y moderna para configurar
        y ejecutar exportaciones masivas de facturas con m√∫ltiples opciones.
    -->
    <record id="view_batch_export_wizard_form" model="ir.ui.view">
        <field name="name">batch.export.wizard.form</field>
        <field name="model">batch.export.wizard</field>
        <field name="arch" type="xml">
            <form string="Exportaci√≥n Masiva de Facturas">
                <header>
                    <!-- Botones de acci√≥n seg√∫n el estado 
                    <button name="action_start_export" 
                            type="object" 
                            string="üöÄ Iniciar Exportaci√≥n" 
                            class="oe_highlight"
                            invisible="state != 'draft'"/>
                    
                    <button name="action_preview_selection" 
                            type="object" 
                            string="üëÅÔ∏è Previsualizar Facturas" 
                            class="btn-secondary"
                            invisible="state != 'draft'"/> -->
                    
                    <button name="action_reset_wizard" 
                            type="object" 
                            string="üîÑ Nueva Exportaci√≥n" 
                            class="btn-secondary"
                            invisible="state in ['draft', 'processing']"/>
                    
                    <!-- Indicador de estado
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,processing,done"/> -->
                </header>

                <sheet>
                    <!-- T√≠tulo y descripci√≥n principal -->
                    <div class="oe_title">
                        <h1>
                            <i class="fa fa-download"/> Exportaci√≥n Masiva de Facturas
                        </h1>
                        <p class="o_form_subtitle">
                            Exporte m√∫ltiples facturas en archivos comprimidos con 
                            soporte multi-formato y opciones avanzadas de configuraci√≥n.
                        </p>
                    </div>

                    <!-- Configuraci√≥n principal (visible solo en estado draft) -->
                    <div invisible="state != 'draft'">
                        
                        <!-- Configuraci√≥n de empresa y plantilla -->
                        <group name="main_config" string="üìä Configuraci√≥n Principal">
                            <group>
                                <field name="company_id" 
                                       options="{'no_create': True, 'no_edit': True}"/>
                                <field name="export_template_id" 
                                       options="{'no_create_edit': True}"/>
                            </group>
                            <group>
                                <field name="compression_format"/>
                                <field name="archive_password" 
                                       password="True"
                                       invisible="compression_format not in ['zip_password', 'zip_password_std']"
                                       required="compression_format in ['zip_password', 'zip_password_std']"/>
                            </group>
                        </group>

                        <!-- Selecci√≥n de facturas -->
                        <group name="invoice_selection" string="üìÑ Selecci√≥n de Facturas">
                            <field name="invoice_ids" 
                                   widget="many2many_tags"
                                   options="{'no_create': True}"
                                   nolabel="1"
                                   placeholder="Facturas seleccionadas desde la vista de lista..."/>
                        </group>
                        
                        <!-- Mensaje informativo para facturas preseleccionadas -->
                        <div class="alert alert-info o_form_sheet_bg" 
                             style="margin: 10px 0; padding: 15px; border-left: 4px solid #0066cc;"
                             invisible="not invoice_ids">
                            <p style="margin: 0;">
                                <i class="fa fa-info-circle"/> <strong>Facturas preseleccionadas:</strong><br/>
                                Se exportar√°n √∫nicamente las facturas seleccionadas desde la vista de lista. 
                                Los filtros de documentos y fechas de abajo se ignorar√°n.
                            </p>
                        </div>

                        <!-- Filtros de documentos (solo si no hay preselecci√≥n) -->
                        <group name="document_filters" 
                               string="üéØ Filtros de Documentos"
                               invisible="invoice_ids">
                            <group>
                                <field name="include_customer_invoices"/>
                                <field name="include_vendor_bills"/>
                                <field name="include_credit_notes"/>
                            </group>
                            <group>
                                <field name="state_filter"/>
                                <field name="partner_ids" 
                                       widget="many2many_tags"
                                       options="{'no_create': True}"/>
                            </group>
                        </group>

                        <!-- Filtros de fecha -->
                        <group name="date_filters" 
                               string="üìÖ Filtros de Fecha"
                               invisible="invoice_ids">
                            <group>
                                <field name="date_from"/>
                                <field name="date_to"/>
                            </group>
                        </group>

                        <!-- Opciones avanzadas -->
                        <group name="advanced_options" string="‚öôÔ∏è Opciones Avanzadas">
                            <group>
                                <field name="batch_size"/>
                            </group>
                        </group>
                    </div>

                    <!-- Indicador de progreso (visible durante procesamiento) -->
                    <div invisible="state != 'processing'" 
                         class="alert alert-info">
                        <h4><i class="fa fa-spinner fa-spin"/> Procesando exportaci√≥n...</h4>
                        <p>Por favor espere mientras se procesan las facturas. 
                           Este proceso puede tomar varios minutos dependiendo de la cantidad de documentos.</p>
                        
                        <div class="progress" style="margin: 10px 0;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 100%">
                                Procesando...
                            </div>
                        </div>
                    </div>

                    <!-- Resultados (visible cuando est√° completado) -->
                    <div invisible="state not in ['done', 'error']">
                        
                        <!-- Estad√≠sticas de la exportaci√≥n -->
                        <group name="export_stats" string="üìä Estad√≠sticas de la Exportaci√≥n">
                            <group string="Facturas Procesadas">
                                <field name="total_invoices" readonly="1" 
                                       string="üìÑ Total de Facturas"/>
                                <field name="processed_invoices" readonly="1"
                                       string="‚úÖ Procesadas Exitosamente"/>
                                <field name="failed_invoices" readonly="1"
                                       string="‚ùå Con Errores"/>
                            </group>
                            <group string="Informaci√≥n del Archivo">
                                <field name="export_size" readonly="1"
                                       string="üì¶ Tama√±o (MB)"/>
                                <field name="processing_time" readonly="1"
                                       string="‚è±Ô∏è Tiempo (segundos)"/>
                            </group>
                        </group>

                        <!-- Descarga del archivo (solo si est√° completado exitosamente) -->
                        <group name="download_section" 
                               string="‚¨áÔ∏è Descargar Archivo Comprimido"
                               invisible="state != 'done'">
                            <field name="export_filename" invisible="1"/>
                            <field name="export_file" 
                                   filename="export_filename" 
                                   widget="binary"
                                   string="üìÅ Archivo de Exportaci√≥n"
                                   help="Haga clic para descargar el archivo ZIP con todas las facturas"/>
                            
                            <!-- Mensaje de √©xito -->
                            <div class="alert alert-success o_form_sheet_bg" 
                                 style="margin: 10px 0; padding: 15px; border-left: 4px solid #28a745;">
                                <p style="margin: 0;">
                                    <i class="fa fa-check-circle"/> <strong>¬°Exportaci√≥n completada!</strong><br/>
                                    El archivo contiene todas las facturas procesadas exitosamente.
                                </p>
                            </div>
                        </group>

                        <!-- Log de procesamiento -->
                        <group name="processing_log_section" string="üìù Registro de Procesamiento">
                            <field name="processing_log" 
                                   widget="text" 
                                   readonly="1"
                                   nolabel="1"
                                   options="{'resizable': True}"
                                   class="o_field_text"
                                   style="font-family: monospace; font-size: 13px; min-height: 200px;"/>
                        </group>
                    </div>

                </sheet>
            </form>
        </field>
    </record>

    <!--
        ACCI√ìN DEL WIZARD
        ================
        
        Define c√≥mo se abre el wizard desde diferentes ubicaciones en Odoo.
    -->
    <record id="action_batch_export_wizard" model="ir.actions.act_window">
        <field name="name">Exportaci√≥n Masiva de Facturas</field>
        <field name="res_model">batch.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_batch_export_wizard_form"/>
        
        <!-- Contexto por defecto -->
        <field name="context">{}</field>
        
        <!-- Ayuda contextual -->
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Exportaci√≥n Masiva de Facturas
            </p>
            <p>
                Configure los filtros y opciones de compresi√≥n para exportar 
                m√∫ltiples facturas en un archivo comprimido.
            </p>
            <p>
                <strong>Caracter√≠sticas disponibles:</strong>
            </p>
            <ul>
                <li>M√∫ltiples formatos de compresi√≥n (ZIP, 7-Zip, TAR.GZ)</li>
                <li>Protecci√≥n con contrase√±a</li>
                <li>Plantillas de nomenclatura personalizables</li>
                <li>Filtros avanzados por fecha, tipo y estado</li>
                <li>Procesamiento optimizado por lotes</li>
            </ul>
        </field>
    </record>

    <!--
        ACCI√ìN DEL MEN√ö CONTEXTUAL EN FACTURAS
        =====================================
        
        Permite acceder al wizard directamente desde la vista de lista de facturas
        con las facturas seleccionadas como preselecci√≥n.
    -->
    <record id="action_batch_export_from_invoices" model="ir.actions.act_window">
        <field name="name">üì¶ Exportar en Lote</field>
        <field name="res_model">batch.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_batch_export_wizard_form"/>
        
        <!-- Configuraci√≥n para que aparezca en las acciones de facturas -->
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        
        <!-- Contexto que incluye las facturas seleccionadas -->
        <field name="context">{}</field>
    </record>

    <!--
        VISTA SIMPLIFICADA PARA SELECCI√ìN R√ÅPIDA
        =======================================
        
        Vista alternativa m√°s simple para casos de uso b√°sicos.
    -->
    <record id="view_batch_export_wizard_simple" model="ir.ui.view">
        <field name="name">batch.export.wizard.simple</field>
        <field name="model">batch.export.wizard</field>
        <field name="arch" type="xml">
            <form string="Exportaci√≥n R√°pida">
                <sheet>
                    <div class="oe_title">
                        <h1>üì¶ Exportaci√≥n R√°pida</h1>
                        <p>Configuraci√≥n simplificada para exportaci√≥n inmediata</p>
                    </div>

                    <group>
                        <group>
                            <field name="compression_format"/>
                            <field name="include_customer_invoices"/>
                            <field name="include_vendor_bills"/>
                        </group>
                        <group>
                            <field name="date_from"/>
                            <field name="date_to"/>
                            <field name="state_filter"/>
                        </group>
                    </group>

                    <footer>
                        <button name="action_start_export" 
                                type="object" 
                                string="Exportar Ahora" 
                                class="btn-primary"/>
                        <button string="Cancelar" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>

    <!--
        ACCI√ìN PARA VISTA SIMPLIFICADA
        =============================
    -->
    <record id="action_batch_export_wizard_simple" model="ir.actions.act_window">
        <field name="name">Exportaci√≥n R√°pida</field>
        <field name="res_model">batch.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_batch_export_wizard_simple"/>
    </record>

</odoo>
