<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ============================================ -->
    <!-- VISTA FORMULARIO DEL WIZARD DE EXPORTACI√ìN  -->
    <!-- ============================================ -->
    <record id="view_batch_export_wizard_form" model="ir.ui.view">
        <field name="name">batch.export.wizard.form</field>
        <field name="model">batch.export.wizard</field>
        <field name="arch" type="xml">
            <form string="Exportaci√≥n Masiva de Facturas">
                
                <!-- ===================================== -->
                <!-- ENCABEZADO CON INFORMACI√ìN GENERAL   -->
                <!-- ===================================== -->
                <div class="oe_title">
                    <h1>
                        <i class="fa fa-download"/> Exportaci√≥n Masiva de Facturas
                    </h1>
                    <p class="text-muted">
                        Exporta m√∫ltiples facturas en un archivo ZIP con nombres descriptivos
                    </p>
                </div>
                
                <!-- ===================================== -->
                <!-- CONFIGURACI√ìN Y FILTROS             -->
                <!-- ===================================== -->
                <group name="config_section" invisible="export_file">
                    <group string="üè¢ Configuraci√≥n Empresa">
                        <field name="company_id" 
                               options="{'no_create': True}"
                               widget="selection"/>
                    </group>
                    
                    <group string="üìÖ Filtros de Fecha">
                        <field name="date_from"/>
                        <field name="date_to"/>
                    </group>
                    
                    <group string="üìÑ Tipo de Documento">
                        <field name="invoice_type" widget="radio"/>
                        <field name="state_filter" widget="radio"/>
                    </group>
                    
                    <group string="üë• Contactos (Opcional)" colspan="4">
                        <field name="partner_ids" 
                               widget="many2many_tags"
                               placeholder="Dejar vac√≠o para incluir todos los contactos"
                               options="{'no_create': True}"/>
                    </group>
                    
                    <!-- INFO BOX CON MEJORES PR√ÅCTICAS DE ACCESIBILIDAD -->
                    <div class="alert alert-info" role="alert" colspan="4">
                        <div class="d-flex align-items-center">
                            <i class="fa fa-info-circle me-2" title="Informaci√≥n importante sobre la exportaci√≥n"/>
                            <div>
                                <strong>‚ÑπÔ∏è Informaci√≥n Importante:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Solo se exportar√°n facturas en estado v√°lido (con PDF generado)</li>
                                    <li>Los archivos se nombrar√°n: [TIPO]_[N√öMERO]_[CLIENTE]_[FECHA].pdf</li>
                                    <li>Para grandes vol√∫menes (+200 facturas), el proceso puede tardar varios minutos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </group>

                <!-- ===================================== -->
                <!-- RESULTADOS DE LA EXPORTACI√ìN        -->
                <!-- ===================================== -->
                <group name="results_section" invisible="not export_file">
                    <group string="üìä Resultados de Exportaci√≥n" colspan="4">
                        <div class="alert alert-success" role="alert" colspan="4">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-check-circle me-2 text-success" 
                                   title="Exportaci√≥n completada exitosamente"/>
                                <div>
                                    <strong>‚úÖ Exportaci√≥n Completada</strong>
                                    <p class="mb-0 mt-1">
                                        Su archivo ZIP est√° listo para descargar
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <group>
                            <field name="export_count" 
                                   readonly="1"
                                   string="üìã Facturas Exportadas"/>
                            <field name="failed_count" 
                                   readonly="1"
                                   string="‚ö†Ô∏è Facturas con Error"
                                   invisible="failed_count == 0"/>
                            <field name="processing_time" 
                                   readonly="1"
                                   string="‚è±Ô∏è Tiempo de Procesamiento (seg)"
                                   widget="float_time"/>
                        </group>
                        
                        <group>
                            <field name="export_filename" 
                                   readonly="1"
                                   string="üìÅ Nombre del Archivo"/>
                            <field name="export_file" 
                                   invisible="1"/>
                        </group>
                        
                        <!-- LOG DE ERRORES SI LOS HAY -->
                        <group colspan="4" invisible="not error_log">
                            <div class="alert alert-warning" role="alert">
                                <div class="d-flex align-items-start">
                                    <i class="fa fa-exclamation-triangle me-2 text-warning" 
                                       title="Advertencia: Algunas facturas no pudieron procesarse"/>
                                    <div>
                                        <strong>‚ö†Ô∏è Advertencias de Procesamiento</strong>
                                        <field name="error_log" 
                                               readonly="1"
                                               nolabel="1"
                                               widget="text"
                                               class="mt-2"/>
                                    </div>
                                </div>
                            </div>
                        </group>
                    </group>
                </group>

                <!-- ===================================== -->
                <!-- BOTONES DE ACCI√ìN                   -->
                <!-- ===================================== -->
                <footer>
                    <div class="d-flex justify-content-between w-100">
                        <!-- Botones lado izquierdo -->
                        <div>
                            <button name="action_export_invoices" 
                                    type="object" 
                                    string="üöÄ Iniciar Exportaci√≥n"
                                    class="btn-primary"
                                    invisible="export_file"
                                    confirm="¬øEst√° seguro de que desea exportar las facturas con los filtros seleccionados?"/>
                        </div>
                        
                        <!-- Botones lado derecho -->
                        <div>
                            <button name="action_download_zip" 
                                    type="object" 
                                    string="üì• Descargar ZIP"
                                    class="btn-success"
                                    invisible="not export_file"/>
                            
                            <button name="action_reset_wizard" 
                                    type="object" 
                                    string="üîÑ Nueva Exportaci√≥n"
                                    class="btn-secondary ms-2"
                                    invisible="not export_file"/>
                            
                            <button string="‚ùå Cerrar" 
                                    class="btn-secondary ms-2" 
                                    special="cancel"/>
                        </div>
                    </div>
                </footer>
                
            </form>
        </field>
    </record>

    <!-- ============================================ -->
    <!-- ACCI√ìN DE VENTANA PARA EL WIZARD           -->
    <!-- ============================================ -->
    <record id="action_batch_export_wizard" model="ir.actions.act_window">
        <field name="name">Exportaci√≥n Masiva de Facturas</field>
        <field name="res_model">batch.export.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>

    <!-- ============================================ -->
    <!-- ELEMENTO DE MEN√ö                           -->
    <!-- ============================================ -->
    <menuitem id="menu_batch_export_wizard"
              name="Exportar Facturas Masivo"
              parent="account.menu_finance_reports"
              action="action_batch_export_wizard"
              sequence="100"/>

    <!-- ============================================ -->
    <!-- ACCI√ìN DE SERVIDOR PARA LISTA DE FACTURAS  -->
    <!-- ============================================ -->
    <record id="action_batch_export_from_invoice_list" model="ir.actions.server">
        <field name="name">Exportar Seleccionadas a ZIP</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
# Verificar que hay facturas seleccionadas
if not context.get('active_ids'):
    raise UserError('Debe seleccionar al menos una factura.')

# Crear wizard con facturas preseleccionadas
wizard = env['batch.export.wizard'].create({
    'company_id': env.company.id,
})

# Retornar acci√≥n para abrir el wizard
action = {
    'name': 'Exportaci√≥n Masiva de Facturas',
    'type': 'ir.actions.act_window',
    'res_model': 'batch.export.wizard',
    'res_id': wizard.id,
    'view_mode': 'form',
    'target': 'new',
    'context': {
        'default_invoice_ids': context.get('active_ids', []),
    }
}
        </field>
    </record>

</odoo>
