<?xml version="1.0" encoding="utf-8"?>
<!--
=============================================================================
EXTENSIONES DE VISTA PARA CONFIGURACI√ìN DE EMPRESA
=============================================================================

Este archivo extiende la vista de empresa (res.company) para a√±adir
configuraciones espec√≠ficas del m√≥dulo de exportaci√≥n masiva.

FILOSOF√çA DE INTEGRACI√ìN:
========================
En lugar de crear configuraciones separadas, integramos la funcionalidad
directamente en la vista de empresa existente. Esto tiene ventajas:

1. DESCUBRIBILIDAD: Los usuarios encuentran las configuraciones donde esperan
2. CONTEXTO: Las configuraciones est√°n junto a otros datos de empresa
3. USABILIDAD: No hay navegaci√≥n adicional entre diferentes pantallas
4. CONSISTENCIA: Sigue los patrones est√°ndar de Odoo

PATRONES IMPLEMENTADOS:
======================
- Smart Buttons: Para navegaci√≥n contextual a plantillas relacionadas
- Campos Computed: Para mostrar estad√≠sticas din√°micas
- Extensi√≥n de Vista: Sin modificar el core de Odoo
- Configuraciones Opcionales: Solo aparecen cuando son relevantes
-->

<odoo>
    <data>

        <!-- 
        =================================================================
        EXTENSI√ìN PRINCIPAL DE LA VISTA DE EMPRESA
        =================================================================
        
        Esta vista a√±ade una secci√≥n completa de configuraci√≥n de exportaci√≥n
        a la vista est√°ndar de empresa.
        -->
        <record id="view_company_form_export_settings" model="ir.ui.view">
            <field name="name">res.company.form.export.settings</field>
            <field name="model">res.company</field>
            <field name="inherit_id" ref="base.view_company_form"/>
            <field name="priority">16</field>
            <field name="arch" type="xml">
                
                <!-- Insertar despu√©s de la configuraci√≥n general -->
                <xpath expr="//notebook" position="inside">
                    <page string="üì¶ Exportaci√≥n de Facturas" name="export_settings">
                        
                        <!-- Mensaje de bienvenida y descripci√≥n -->
                        <div class="alert alert-info" style="margin: 15px 0;">
                            <h4><i class="fa fa-info-circle"/> Configuraci√≥n de Exportaci√≥n Masiva</h4>
                            <p style="margin-bottom: 0;">
                                Configura c√≥mo se comportar√° la exportaci√≥n masiva de facturas para esta empresa.
                                Estas configuraciones servir√°n como valores por defecto que los usuarios pueden
                                ajustar seg√∫n sus necesidades espec√≠ficas.
                            </p>
                        </div>

                        <!-- Smart Buttons para gesti√≥n de plantillas -->
                        <div class="oe_button_box" name="button_box">
                            
                            <!-- Smart Button para ver plantillas de exportaci√≥n -->
                            <button class="oe_stat_button" 
                                    name="action_open_export_templates"
                                    type="object"
                                    icon="fa-file-text-o">
                                <field name="export_template_count" widget="statinfo" string="Plantillas"/>
                            </button>
                            
                            <!-- Smart Button para crear nueva plantilla -->
                            <button class="oe_stat_button" 
                                    name="action_create_export_template"
                                    type="object"
                                    icon="fa-plus">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Nueva</span>
                                    <span class="o_stat_text">Plantilla</span>
                                </div>
                            </button>
                        </div>

                        <!-- Configuraciones de exportaci√≥n -->
                        <group name="export_configuration">
                            
                            <!-- Configuraciones b√°sicas -->
                            <group string="‚öôÔ∏è Configuraciones B√°sicas" name="basic_export_config">
                                <field name="default_compression_format" 
                                       string="Formato de Compresi√≥n Por Defecto"/>
                                
                                <field name="default_batch_size" 
                                       string="Tama√±o de Lote Por Defecto"/>
                                
                                <field name="max_export_invoices" 
                                       string="M√°ximo de Facturas por Exportaci√≥n"/>
                            </group>
                            
                            <!-- Configuraciones de nomenclatura -->
                            <group string="üìù Configuraciones de Nomenclatura" name="naming_config">
                                <field name="use_custom_filename_pattern" 
                                       string="Usar Patr√≥n Personalizado"/>
                                
                                <field name="custom_filename_pattern" 
                                       attrs="{'invisible': [('use_custom_filename_pattern', '=', False)],
                                               'required': [('use_custom_filename_pattern', '=', True)]}"
                                       string="Patr√≥n Personalizado"
                                       placeholder="{type}_{number}_{partner}_{date}.pdf"
                                       help="Variables disponibles: {type}, {number}, {partner}, {date}, {year}, {month}, {company}, {reference}"/>
                            </group>
                        </group>

                        <!-- Informaci√≥n sobre plantilla por defecto -->
                        <group string="üìã Plantilla Por Defecto" name="default_template_info">
                            <field name="default_export_template_id" 
                                   readonly="1"
                                   string="Plantilla Activa"/>
                            
                            <div attrs="{'invisible': [('default_export_template_id', '!=', False)]}" 
                                 class="alert alert-warning" 
                                 style="margin: 10px 0;">
                                <i class="fa fa-exclamation-triangle"/> 
                                <strong>No hay plantilla por defecto configurada.</strong>
                                <br/>
                                <span class="text-muted">
                                    Crea una plantilla usando el bot√≥n "Nueva Plantilla" arriba, 
                                    o se usar√° el patr√≥n est√°ndar del sistema.
                                </span>
                            </div>
                        </group>

                        <!-- Secci√≥n de ayuda y documentaci√≥n -->
                        <group string="‚ùì Ayuda y Documentaci√≥n" name="help_section">
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                                <h4 style="margin-top: 0; color: #495057;">¬øQu√© hace cada configuraci√≥n?</h4>
                                <ul style="margin-bottom: 0; color: #6c757d;">
                                    <li><strong>Formato de Compresi√≥n:</strong> Algoritmo usado para comprimir las exportaciones (ZIP, 7-Zip, etc.)</li>
                                    <li><strong>Tama√±o de Lote:</strong> Cu√°ntas facturas procesar a la vez (afecta memoria del servidor)</li>
                                    <li><strong>M√°ximo de Facturas:</strong> L√≠mite de seguridad para prevenir exportaciones excesivamente grandes</li>
                                    <li><strong>Plantillas:</strong> Definen c√≥mo se nombran los archivos durante la exportaci√≥n</li>
                                </ul>
                            </div>
                        </group>

                    </page>
                </xpath>
            </field>
        </record>

        <!-- 
        =================================================================
        VISTA SIMPLIFICADA PARA USUARIOS B√ÅSICOS
        =================================================================
        
        Vista alternativa con menos opciones para usuarios que no necesitan
        configuraciones avanzadas.
        -->
        <record id="view_company_form_export_simple" model="ir.ui.view">
            <field name="name">res.company.form.export.simple</field>
            <field name="model">res.company</field>
            <field name="inherit_id" ref="base.view_company_form"/>
            <field name="priority">20</field>
            <field name="groups_id" eval="[(4, ref('account.group_account_user'))]"/>
            <field name="arch" type="xml">
                
                <!-- Insertar configuraciones b√°sicas en la configuraci√≥n general -->
                <xpath expr="//group[@name='general_settings']" position="after">
                    <group string="üì¶ Exportaci√≥n de Facturas" 
                           name="export_basic_settings"
                           groups="account.group_account_user">
                        
                        <field name="default_compression_format" 
                               string="Formato de Compresi√≥n Preferido"/>
                        
                        <field name="max_export_invoices" 
                               string="M√°ximo de Facturas por Exportaci√≥n"/>
                        
                        <!-- Acceso directo a plantillas -->
                        <div class="o_row">
                            <button name="action_open_export_templates" 
                                    string="Gestionar Plantillas"
                                    type="object"
                                    class="btn-link"
                                    icon="fa-external-link"/>
                        </div>
                    </group>
                </xpath>
            </field>
        </record>

        <!-- 
        =================================================================
        ACCI√ìN PARA ABRIR CONFIGURACI√ìN DE EXPORTACI√ìN
        =================================================================
        -->
        <record id="action_company_export_config" model="ir.actions.act_window">
            <field name="name">Configuraci√≥n de Exportaci√≥n</field>
            <field name="res_model">res.company</field>
            <field name="view_mode">form</field>
            <field name="target">current</field>
            <field name="context">{
                'form_view_initial_mode': 'edit'
            }</field>
            <field name="domain">[('id', '=', uid)]</field>
            <field name="view_id" ref="view_company_form_export_settings"/>
        </record>

        <!-- 
        =================================================================
        MEN√ö PARA ACCESO DIRECTO A CONFIGURACI√ìN
        =================================================================
        -->
        <menuitem id="menu_company_export_config"
                  name="Configuraci√≥n de Exportaci√≥n"
                  parent="account.menu_finance_configuration"
                  action="action_company_export_config"
                  sequence="10"
                  groups="account.group_account_manager"/>

    </data>
</odoo>
