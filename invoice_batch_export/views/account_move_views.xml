<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        EXTENSIONES PARA VISTA DE FACTURAS
        =================================
        
        Estas vistas extienden las vistas estándar de facturas para añadir
        funcionalidad de exportación masiva directamente desde la interfaz.
    -->

    <!--
        EXTENSIÓN DE LA VISTA DE LISTA DE FACTURAS
        ==========================================
        
        Añade un botón inteligente para acceso rápido a la exportación masiva
        cuando se tienen facturas seleccionadas.
    -->
    <record id="view_account_move_tree_batch_export" model="ir.ui.view">
        <field name="name">account.move.tree.batch.export</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/>
        <field name="arch" type="xml">
            
            <!-- Añadir información en el encabezado de la vista -->
            <xpath expr="//tree" position="attributes">
                <attribute name="banner_route">/invoice_batch_export/banner</attribute>
            </xpath>

        </field>
    </record>

    <!--
        EXTENSIÓN DE LA VISTA DE FORMULARIO DE FACTURAS
        ==============================================
        
        Añade un botón smart para exportar facturas relacionadas o similares.
    -->
    <record id="view_account_move_form_batch_export" model="ir.ui.view">
        <field name="name">account.move.form.batch.export</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            
            <!-- Añadir botón inteligente en el área de smart buttons -->
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button name="action_open_batch_export_for_partner"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-download"
                        invisible="state == 'draft'">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="partner_invoice_count" widget="integer"/>
                        </span>
                        <span class="o_stat_text">Facturas del Cliente</span>
                    </div>
                </button>
            </xpath>

        </field>
    </record>

    <!--
        VISTA PERSONALIZADA PARA SELECCIÓN MASIVA
        =======================================
        
        Vista especializada que facilita la selección masiva de facturas
        con información relevante para exportación.
    -->
    <record id="view_account_move_tree_batch_selection" model="ir.ui.view">
        <field name="name">account.move.tree.batch.selection</field>
        <field name="model">account.move</field>
        <field name="arch" type="xml">
            <tree string="Selección para Exportación Masiva" 
                  sample="1" 
                  multi_edit="1"
                  default_order="invoice_date desc,name desc">
                
                <!-- Indicadores visuales -->
                <field name="message_needaction" invisible="1"/>
                <field name="currency_id" invisible="1"/>
                
                <!-- Información principal para exportación -->
                <field name="name" string="Número"/>
                <field name="partner_id" string="Cliente/Proveedor"/>
                <field name="invoice_date" string="Fecha"/>
                <field name="move_type" string="Tipo" widget="badge"
                       decoration-info="move_type == 'out_invoice'"
                       decoration-warning="move_type == 'in_invoice'"
                       decoration-success="move_type == 'out_refund'"
                       decoration-danger="move_type == 'in_refund'"/>
                
                <!-- Estado -->
                <field name="state" string="Estado" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-success="state == 'posted'"
                       decoration-muted="state == 'cancel'"/>
                
                <!-- Información financiera -->
                <field name="amount_total_signed" 
                       string="Total" 
                       sum="Total"
                       widget="monetary"/>
                
                <!-- Información adicional -->
                <field name="invoice_payment_state" 
                       string="Estado de Pago" 
                       widget="badge"
                       decoration-success="invoice_payment_state == 'paid'"
                       decoration-warning="invoice_payment_state == 'partial'"
                       decoration-danger="invoice_payment_state == 'not_paid'"/>
                
                <!-- Referencias -->
                <field name="ref" string="Referencia" optional="hide"/>
                <field name="invoice_user_id" string="Vendedor" optional="hide"/>
                
                <!-- Empresa (para multi-empresa) -->
                <field name="company_id" 
                       groups="base.group_multi_company" 
                       optional="hide"/>
                
                <!-- Campos técnicos ocultos -->
                <field name="id" invisible="1"/>
                <field name="company_currency_id" invisible="1"/>
            </tree>
        </field>
    </record>

    <!--
        VISTA DE BÚSQUEDA ESPECIALIZADA PARA EXPORTACIÓN
        ==============================================
        
        Filtros y agrupaciones optimizados para el proceso de exportación masiva.
    -->
    <record id="view_account_move_search_batch_export" model="ir.ui.view">
        <field name="name">account.move.search.batch.export</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_move_filter"/>
        <field name="arch" type="xml">
            
            <!-- Añadir filtros específicos para exportación -->
            <xpath expr="//filter[@name='late']" position="after">
                <separator/>
                
                <!-- Filtros para exportación -->
                <filter name="filter_ready_for_export" 
                        string="🚀 Listas para Exportar" 
                        domain="[('state', '=', 'posted'), ('move_type', 'in', ['out_invoice', 'in_invoice'])]"/>
                
                <filter name="filter_this_month" 
                        string="📅 Este Mes" 
                        domain="[('invoice_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')), 
                                ('invoice_date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]"/>
                
                <filter name="filter_last_month" 
                        string="📅 Mes Pasado" 
                        domain="[('invoice_date', '&gt;=', (context_today() - relativedelta(months=1, day=1)).strftime('%Y-%m-%d')), 
                                ('invoice_date', '&lt;=', (context_today() - relativedelta(months=1, day=31)).strftime('%Y-%m-%d'))]"/>
                
                <filter name="filter_quarter" 
                        string="📅 Este Trimestre" 
                        domain="[('invoice_date', '&gt;=', time.strftime('%Y-%m-01')), 
                                ('invoice_date', '&lt;=', time.strftime('%Y-%m-%d'))]"/>
            </xpath>

            <!-- Añadir agrupaciones útiles para exportación -->
            <xpath expr="//group[@string='Group By']" position="inside">
                <filter name="group_by_move_type" 
                        string="Tipo de Documento" 
                        context="{'group_by': 'move_type'}"/>
                
                <filter name="group_by_invoice_month" 
                        string="Mes de Factura" 
                        context="{'group_by': 'invoice_date:month'}"/>
                
                <filter name="group_by_payment_state" 
                        string="Estado de Pago" 
                        context="{'group_by': 'invoice_payment_state'}"/>
            </xpath>

        </field>
    </record>

    <!--
        ACCIÓN ESPECIALIZADA PARA SELECCIÓN DE EXPORTACIÓN
        ================================================
        
        Acción que abre la vista de facturas optimizada para exportación masiva.
    -->
    <record id="action_account_move_batch_export_selection" model="ir.actions.act_window">
        <field name="name">Seleccionar Facturas para Exportar</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_account_move_tree_batch_selection"/>
        <field name="search_view_id" ref="view_account_move_search_batch_export"/>
        
        <!-- Dominio para mostrar solo facturas válidas -->
        <field name="domain">[
            ('move_type', 'in', ['out_invoice', 'in_invoice', 'out_refund', 'in_refund']),
            ('state', 'in', ['posted', 'draft'])
        ]</field>
        
        <!-- Contexto optimizado -->
        <field name="context">{
            'default_move_type': 'out_invoice',
            'search_default_filter_ready_for_export': 1,
            'export_mode': True,
        }</field>
        
        <!-- Información de ayuda -->
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                📄 Selecciona las facturas que quieres exportar
            </p>
            <p>
                Usa los filtros para encontrar las facturas que necesitas exportar, 
                selecciónalas marcando las casillas correspondientes, y luego usa 
                el botón "Acción" para acceder a la exportación masiva.
            </p>
            <p>
                <strong>Consejos:</strong>
            </p>
            <ul>
                <li>🔍 Usa los filtros predefinidos para encontrar facturas rápidamente</li>
                <li>📅 Filtra por mes o trimestre para exportaciones periódicas</li>
                <li>✅ Solo se pueden exportar facturas confirmadas por defecto</li>
                <li>🏢 En entornos multi-empresa, se muestran facturas de tu empresa actual</li>
            </ul>
        </field>
    </record>

</odoo>
