<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!--
        ============================================================================
        VISTAS PERSONALIZADAS PARA FACTURAS - ECOCAUCHO
        ============================================================================
        
        Este archivo añade los campos personalizados del módulo al formulario de
        facturas de Odoo, para que los usuarios puedan ver y editar estos campos
        desde la interfaz.
        
        Los campos añadidos son:
        - Referencia Cliente: Campo de texto para el número de referencia del cliente
        - Contacto de Facturación: Selector de contacto específico dentro de la empresa
        - Instrucciones Especiales: Campo de texto largo para notas adicionales
        - Pedidos Relacionados: Campo calculado que muestra automáticamente los pedidos
        ============================================================================
    -->
    
    <!-- 
        Herencia de la vista de formulario de facturas
        Usamos inherit_id para extender la vista estándar sin reemplazarla
    -->
    <record id="view_move_form_inherit_plantilla_factura" model="ir.ui.view">
        <field name="name">account.move.form.inherit.plantilla.factura</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            
            <!-- 
                Insertamos nuestros campos después del campo "ref" (referencia)
                que ya existe en el formulario estándar de facturas
            -->
            <xpath expr="//field[@name='ref']" position="after">
                
                <!-- 
                    Referencia del Cliente
                    Visible solo en facturas de cliente (out_invoice, out_refund)
                    Invisible en facturas de proveedor
                -->
                <field name="referencia_cliente"
                       placeholder="Ej: OC-2024-001"
                       invisible="move_type not in ('out_invoice', 'out_refund')"/>
                
                <!-- 
                    Contacto de Facturación
                    Selector Many2one que permite elegir un contacto específico
                    del cliente para la facturación
                    
                    El dominio limita las opciones a contactos que:
                    1. Son hijos del partner principal (parent_id = partner_id)
                    2. Tienen tipo 'invoice' (contacto de facturación)
                -->
                <field name="contacto_facturacion"
                       placeholder="Selecciona contacto de facturación"
                       options="{'no_create': True, 'no_open': True}"
                       invisible="move_type not in ('out_invoice', 'out_refund')"/>
            </xpath>
            
            <!-- 
                Insertamos el campo de pedidos relacionados en la pestaña
                "Otra información" junto con otros datos de referencia
            -->
            <xpath expr="//page[@name='other_info']//group[@name='other_info_group']" position="inside">
                <!-- 
                    Pedidos Relacionados
                    Este es un campo calculado automáticamente, por eso es readonly
                    Muestra los números de pedido de donde provienen las líneas
                -->
                <field name="pedidos_relacionados" 
                       readonly="1"
                       placeholder="Se calculará automáticamente"/>
            </xpath>
            
            <!-- 
                Insertamos el campo de instrucciones especiales al final del formulario,
                antes de las pestañas (notebook), para que sea visible y destacado
            -->
            <xpath expr="//notebook" position="before">
                <group string="Instrucciones Especiales" 
                       name="special_instructions_group"
                       invisible="move_type not in ('out_invoice', 'out_refund', 'in_invoice', 'in_refund')">
                    <!-- 
                        Campo de texto largo para notas
                        Útil para instrucciones de entrega, requisitos especiales, etc.
                    -->
                    <field name="instrucciones_especiales" 
                           placeholder="Añade cualquier instrucción especial que deba aparecer en la factura impresa"
                           nolabel="1"/>
                </group>
            </xpath>
            
        </field>
    </record>
    
</odoo>
