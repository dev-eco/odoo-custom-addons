<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Plantilla contenedora principal -->
    <template id="report_factura_personalizada">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="plantilla_factura.report_factura_documento" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>
    
    <!-- Plantilla del documento de factura -->
    <template id="report_factura_documento">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=lang)" />
            <t t-set="currency" t-value="o.currency_id" />
            
            <div class="page">
                <!-- Encabezado de la factura -->
                <div class="row mb-4">
                    <div class="col-8">
                        <h2>
                            <span t-if="o.move_type == 'out_invoice'">Factura</span>
                            <span t-elif="o.move_type == 'out_refund'">Nota de Crédito</span>
                            <span t-elif="o.move_type == 'in_invoice'">Factura de Proveedor</span>
                            <span t-elif="o.move_type == 'in_refund'">Nota de Crédito de Proveedor</span>
                            <span t-esc="o.name"/>
                        </h2>
                    </div>
                    <div class="col-4 text-end">
                        <div t-if="o.referencia_cliente">
                            <strong>Referencia Cliente:</strong><br/>
                            <span t-field="o.referencia_cliente"/>
                        </div>
                    </div>
                </div>
                
                <!-- Información del cliente y factura -->
                <div class="row mb-4">
                    <!-- Información del cliente -->
                    <div class="col-6">
                        <div class="invoice-box p-3 border rounded">
                            <strong>Cliente:</strong>
                            <address t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
                            <div t-if="o.partner_id.vat" class="mt-1">
                                <strong>NIF:</strong> <span t-field="o.partner_id.vat"/>
                            </div>
                            <div t-if="o.contacto_facturacion" class="mt-2">
                                <strong>Contacto:</strong> <span t-field="o.contacto_facturacion.name"/>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de la factura -->
                    <div class="col-6">
                        <div class="invoice-box p-3 border rounded">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Fecha Factura:</strong><br/>
                                    <span t-field="o.invoice_date"/>
                                </div>
                                <div class="col-6">
                                    <strong>Fecha Vencimiento:</strong><br/>
                                    <span t-field="o.invoice_date_due"/>
                                </div>
                            </div>
                            
                            <div t-if="o.pedidos_relacionados" class="mt-2">
                                <strong>Pedidos:</strong><br/>
                                <span t-field="o.pedidos_relacionados"/>
                            </div>
                            
                            <div t-if="o.payment_reference" class="mt-2">
                                <strong>Referencia Pago:</strong><br/>
                                <span t-field="o.payment_reference"/>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de líneas de factura -->
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Pedido</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Precio Unit.</th>
                            <th class="text-end">Impuestos</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.invoice_line_ids" t-as="line">
                            <!-- Omitir líneas de sección y nota -->
                            <t t-if="not line.display_type">
                                <tr>
                                    <td>
                                        <span t-field="line.product_id.name"/><br/>
                                        <span t-field="line.name" t-if="line.name != line.product_id.name"/>
                                    </td>
                                    <td>
                                        <span t-if="line.sale_line_ids">
                                            <t t-foreach="line.sale_line_ids" t-as="sale_line">
                                                <span t-field="sale_line.order_id.name"/><t t-if="not sale_line_last">, </t>
                                            </t>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span t-field="line.quantity"/>
                                        <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-field="line.price_unit"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-if="line.tax_ids">
                                            <t t-foreach="line.tax_ids" t-as="tax">
                                                <span t-field="tax.amount"/>%<t t-if="not tax_last">, </t>
                                            </t>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span t-field="line.price_subtotal"/>
                                    </td>
                                </tr>
                            </t>
                            <!-- Líneas de tipo sección -->
                            <t t-if="line.display_type == 'line_section'">
                                <tr>
                                    <td colspan="6" class="text-start">
                                        <strong t-field="line.name"/>
                                    </td>
                                </tr>
                            </t>
                            <!-- Líneas de tipo nota -->
                            <t t-if="line.display_type == 'line_note'">
                                <tr>
                                    <td colspan="6" class="text-start fst-italic">
                                        <span t-field="line.name"/>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>
                
                <!-- Instrucciones especiales -->
                <div t-if="o.instrucciones_especiales" class="row mb-4">
                    <div class="col-12 alert alert-info py-2">
                        <strong>Instrucciones Especiales:</strong>
                        <p t-field="o.instrucciones_especiales"/>
                    </div>
                </div>
                
                <!-- Tabla de totales -->
                <div class="row justify-content-end">
                    <div class="col-4">
                        <table class="table table-sm">
                            <t t-foreach="o.tax_totals['subtotals']" t-as="subtotal">
                                <tr>
                                    <td class="text-end"><span t-esc="subtotal['name']"/></td>
                                    <td class="text-end">
                                        <span t-esc="subtotal['formatted_amount']"/>
                                    </td>
                                </tr>
                            </t>
                            <tr class="border-top">
                                <td class="text-end"><strong>Total</strong></td>
                                <td class="text-end">
                                    <strong t-esc="o.tax_totals['formatted_amount_total']"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Información bancaria -->
                <div class="row mt-4" t-if="o.company_id.partner_id.bank_ids">
                    <div class="col-12">
                        <h6>Información Bancaria</h6>
                        <div class="row">
                            <t t-foreach="o.company_id.partner_id.bank_ids" t-as="bank">
                                <div class="col-6 mb-2">
                                    <strong><span t-field="bank.bank_id.name"/>:</strong>
                                    <span t-field="bank.acc_number"/>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
                
                <!-- Notas y condiciones -->
                <div class="row mt-4">
                    <div class="col-12">
                        <p t-if="o.narration" class="fst-italic">
                            <span t-field="o.narration"/>
                        </p>
                        <p class="text-center text-muted">
                            Gracias por su confianza.
                        </p>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Estilos personalizados -->
    <template id="report_facturas_styles" inherit_id="web.report_assets_common">
        <xpath expr="." position="inside">
            <style>
                .invoice-box {
                    background-color: #f9f9f9;
                }
                
                /* Reducir espaciado general */
                .page {
                    font-size: 0.95rem;
                }
                
                /* Compactar tabla */
                .table-sm td, .table-sm th {
                    padding: 0.3rem !important;
                }
            </style>
        </xpath>
    </template>
</odoo>
