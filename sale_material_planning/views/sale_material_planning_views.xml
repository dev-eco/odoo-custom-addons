<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- No incluimos los estilos CSS aquí, ya están en el archivo scss -->
    <!-- Añadimos los campos calculados a la vista de formulario existente -->
    <record id="view_order_form_material_planning" model="ir.ui.view">
        <field name="name">sale.order.form.material.planning</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                <page string="Planificación de Material" name="material_planning">
                    <header>
                        <button name="action_mark_as_shipped" string="Marcar como Salida" type="object" 
                                class="oe_highlight" invisible="order_status == 'shipped'"/>
                        <button name="action_mark_as_prepared" string="Marcar como Preparado" type="object" 
                                class="oe_highlight" invisible="order_status == 'prepared'"/>
                        <button name="action_mark_as_manufacturing" string="Marcar como En Fabricación" type="object" 
                                invisible="order_status == 'manufacturing'"/>
                        <button name="action_mark_as_warehouse" string="Marcar como En Almacén" type="object" 
                                invisible="order_status == 'warehouse'"/>
                    </header>
                    <group>
                        <group>
                            <field name="delivery_date"/>
                            <field name="days_to_delivery"/>
                            <field name="is_urgent"/>
                            <field name="order_status" widget="radio"/>
                        </group>
                        <group>
                            <field name="total_product_qty"/>
                            <field name="picking_status" widget="badge" 
                                   decoration-success="picking_status == 'done'" 
                                   decoration-info="picking_status == 'assigned'" 
                                   decoration-warning="picking_status == 'partially_available'" 
                                   decoration-danger="picking_status in ['not_created', 'waiting']"/>
                        </group>
                    </group>
                    <group>
                        <field name="product_summary"/>
                    </group>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Vista de lista personalizada para planificación de material -->
    <record id="view_order_tree_material_planning" model="ir.ui.view">
        <field name="name">sale.order.tree.material.planning</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <tree string="Pedidos para Planificación de Material">
                <field name="name" string="Pedido"/>
                <field name="partner_id"/>
                <field name="delivery_date"/>
                <field name="days_to_delivery" 
                       decoration-warning="days_to_delivery &lt;= 3 and days_to_delivery &gt; 0 and picking_status != 'done'"
                       decoration-danger="days_to_delivery &lt;= 0 and picking_status != 'done'"/>
                <field name="is_urgent" widget="boolean_toggle" decoration-danger="is_urgent == True"/>
                <field name="order_status" decoration-success="order_status == 'shipped'" 
                       decoration-info="order_status == 'prepared'"
                       decoration-primary="order_status == 'manufacturing'" 
                       decoration-warning="order_status == 'warehouse'"/>
                <field name="total_product_qty" sum="Total"/>
                <field name="picking_status" widget="badge" 
                       decoration-success="picking_status == 'done'" 
                       decoration-info="picking_status == 'assigned'" 
                       decoration-warning="picking_status == 'partially_available'" 
                       decoration-danger="picking_status in ['not_created', 'waiting']"/>
                <field name="product_summary"/>
                <field name="commitment_date" invisible="1"/>
                <field name="expected_date" invisible="1"/>
                <field name="amount_total" sum="Total" widget="monetary"/>
            </tree>
        </field>
    </record>

    <!-- Vista Kanban para planificación de material -->
    <record id="view_sale_order_kanban_material_planning" model="ir.ui.view">
        <field name="name">sale.order.kanban.material.planning</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <kanban default_group_by="delivery_date:day" class="o_kanban_small_column">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="product_summary"/>
                <field name="total_product_qty"/>
                <field name="delivery_date"/>
                <field name="days_to_delivery"/>
                <field name="is_urgent"/>
                <field name="order_status"/>
                <field name="picking_status"/>
                <field name="state"/>
                <field name="amount_total"/>
                <field name="color"/>
                <field name="company_id"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.order_status.raw_value == 'shipped' ? 'bg-success-light' : ''} #{record.order_status.raw_value == 'manufacturing' ? 'bg-info-light' : ''} #{record.is_urgent.raw_value and record.order_status.raw_value != 'shipped' ? 'bg-danger-light' : ''} #{record.days_to_delivery.raw_value &lt;= 0 and record.order_status.raw_value != 'shipped' ? 'bg-warning-light' : ''} #{record.picking_status.raw_value == 'done' and record.order_status.raw_value != 'shipped' ? 'bg-success-light' : ''}">
                            <div class="oe_kanban_details">
                                <div class="d-flex justify-content-between">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/> - <field name="partner_id"/>
                                    </strong>
                                    <span t-if="record.order_status.raw_value == 'shipped'" class="badge badge-success">SALIDA</span>
                                    <span t-elif="record.order_status.raw_value == 'prepared'" class="badge badge-info">PREPARADO</span>
                                    <span t-elif="record.order_status.raw_value == 'manufacturing'" class="badge badge-primary">FABRICACIÓN</span>
                                    <span t-elif="record.is_urgent.raw_value" class="badge badge-danger">URGENTE</span>
                                </div>
                                <div class="o_kanban_record_subtitle">
                                    <span t-if="record.total_product_qty.raw_value">
                                        <t t-esc="record.total_product_qty.raw_value"/> unidades
                                    </span>
                                    <span t-if="record.amount_total.raw_value" class="pull-right">
                                        <t t-esc="record.amount_total.value"/>
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span t-attf-class="badge #{record.state.raw_value == 'sale' ? 'badge-success' : record.state.raw_value == 'draft' ? 'badge-info' : 'badge-secondary'}">
                                        <t t-esc="record.state.value"/>
                                    </span>
                                    <span t-attf-class="badge #{record.picking_status.raw_value == 'done' ? 'badge-success' : 
                                                               record.picking_status.raw_value == 'assigned' ? 'badge-info' : 
                                                               record.picking_status.raw_value == 'partially_available' ? 'badge-warning' : 'badge-danger'}">
                                        <t t-esc="record.picking_status.value"/>
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <span class="text-muted">Entrega: </span>
                                    <field name="delivery_date"/>
                                    <span class="ml-2" t-if="record.days_to_delivery.raw_value &lt;= 0">
                                        <span class="badge badge-danger">HOY</span>
                                    </span>
                                    <span class="ml-2" t-elif="record.days_to_delivery.raw_value == 1">
                                        <span class="badge badge-warning">MAÑANA</span>
                                    </span>
                                    <span class="ml-2" t-elif="record.days_to_delivery.raw_value &lt;= 3">
                                        <span class="badge badge-info">En <t t-esc="record.days_to_delivery.value"/> días</span>
                                    </span>
                                </div>
                                <div style="padding-top: 10px;">
                                    <field name="product_summary" style="white-space: pre-wrap;"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Filtros personalizados para la búsqueda -->
    <record id="view_sales_order_filter_material_planning" model="ir.ui.view">
        <field name="name">sale.order.list.select.material.planning</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <filter name="my_sale_orders_filter" position="after">
                <filter string="Mi Empresa" name="my_company" domain="[('company_id', '=', allowed_company_ids[0])]"/>
                <separator/>
                <filter string="Entrega Hoy" name="delivery_today" domain="[('delivery_date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Entrega Mañana" name="delivery_tomorrow" domain="[('delivery_date', '=', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Entrega Esta Semana" name="delivery_this_week" domain="[
                    ('delivery_date', '&gt;=', context_today().strftime('%Y-%m-%d')),
                    ('delivery_date', '&lt;=', (context_today() + relativedelta(days=7)).strftime('%Y-%m-%d'))
                ]"/>
                <separator/>
                <filter string="Pendientes de Entrega" name="pending_delivery" domain="[
                    ('state', '=', 'sale'),
                    ('delivery_date', '!=', False)
                ]"/>
                <separator/>
                <filter string="Urgentes" name="urgent_orders" domain="[('is_urgent', '=', True)]"/>
                <filter string="Salida" name="shipped_orders" domain="[('order_status', '=', 'shipped')]"/>
                <filter string="Preparado" name="prepared_orders" domain="[('order_status', '=', 'prepared')]"/>
                <filter string="En Fabricación" name="manufacturing_orders" domain="[('order_status', '=', 'manufacturing')]"/>
                <filter string="En Almacén" name="warehouse_orders" domain="[('order_status', '=', 'warehouse')]"/>
                <filter string="Entrega Atrasada" name="late_delivery" domain="[('days_to_delivery', '&lt;=', 0), ('picking_status', '!=', 'done')]"/>
                <separator/>
                <filter string="Albarán No Creado" name="picking_not_created" domain="[('picking_status', '=', 'not_created')]"/>
                <filter string="Albarán Esperando" name="picking_waiting" domain="[('picking_status', '=', 'waiting')]"/>
                <filter string="Albarán Parcialmente Disponible" name="picking_partially" domain="[('picking_status', '=', 'partially_available')]"/>
                <filter string="Albarán Reservado" name="picking_assigned" domain="[('picking_status', '=', 'assigned')]"/>
                <filter string="Albarán Realizado" name="picking_done" domain="[('picking_status', '=', 'done')]"/>
            </filter>
            <filter name="customer" position="after">
                <filter string="Empresa" name="company" context="{'group_by': 'company_id'}"/>
                <filter string="Fecha de Entrega (Día)" name="delivery_date_day" context="{'group_by': 'delivery_date:day'}"/>
                <filter string="Fecha de Entrega (Mes)" name="delivery_date_month" context="{'group_by': 'delivery_date:month'}"/>
                <filter string="Estado del Albarán" name="picking_status_group" context="{'group_by': 'picking_status'}"/>
                <filter string="Urgencia" name="urgent_group" context="{'group_by': 'is_urgent'}"/>
                <filter string="Estado de Pedido" name="order_status_group" context="{'group_by': 'order_status'}"/>
            </filter>
        </field>
    </record>

    <!-- Acción para abrir vista de planificación -->
    <record id="action_sale_order_material_planning" model="ir.actions.act_window">
        <field name="name">Planificación de Material</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('state', 'not in', ['cancel'])]</field>
        <field name="context">{
            'search_default_pending_delivery': 1,
            'search_default_delivery_date_day': 1,
            'search_default_late_delivery': 0,
            'search_default_urgent_orders': 0,
            'search_default_my_company': 1
        }</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_sale_order_kanban_material_planning')}),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('view_order_tree_material_planning')})]"/>
        <field name="search_view_id" ref="view_sales_order_filter_material_planning"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pedidos pendientes para planificar.
            </p>
        </field>
    </record>

    <!-- Elemento de menú -->
    <menuitem id="menu_sale_material_planning"
              name="Planificación de Material"
              parent="sale.sale_menu_root"
              sequence="5"
              action="action_sale_order_material_planning"
              groups="sales_team.group_sale_salesman"/>
</odoo>
