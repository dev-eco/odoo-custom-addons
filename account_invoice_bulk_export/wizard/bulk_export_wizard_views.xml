<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vista principal del wizard mejorado -->
        <record id="view_bulk_export_wizard_form" model="ir.ui.view">
            <field name="name">account.bulk.export.wizard.form</field>
            <field name="model">account.bulk.export.wizard</field>
            <field name="arch" type="xml">
                <form string="Exportaci√≥n Masiva de Facturas">

                    <!-- Header con controles de estado y botones -->
                    <header>
                        <field name="state" invisible="1"/>
                        
                        <!-- Bot√≥n: Ir a Vista Previa -->
                        <button name="action_show_preview" 
                                type="object" 
                                string="Vista Previa" 
                                class="btn-primary" 
                                invisible="state != 'draft'"
                                icon="fa-search"/>
                        
                        <!-- Bot√≥n: Volver a Configuraci√≥n -->
                        <button name="action_back_to_config" 
                                type="object" 
                                string="Volver a Configuraci√≥n" 
                                class="btn-secondary" 
                                invisible="state != 'preview'"
                                icon="fa-arrow-left"/>
                        
                        <!-- Bot√≥n: Iniciar Exportaci√≥n -->
                        <button name="action_start_export" 
                                type="object" 
                                string="Iniciar Exportaci√≥n" 
                                class="btn-primary" 
                                invisible="state != 'preview'"
                                icon="fa-download"
                                confirm="¬øDesea iniciar la exportaci√≥n de las facturas seleccionadas?"/>
                        
                        <!-- Bot√≥n: Descargar Archivo -->
                        <button name="action_download" 
                                type="object" 
                                string="Descargar Archivo" 
                                class="btn-success" 
                                invisible="state != 'done'"
                                icon="fa-cloud-download"/>
                        
                        <!-- Bot√≥n: Ver Historial -->
                        <button name="action_view_export_history" 
                                type="object" 
                                string="Ver en Historial" 
                                class="btn-info" 
                                invisible="state != 'done' or not export_history_id"
                                icon="fa-history"/>
                        
                        <field name="export_history_id" invisible="1"/>
                        
                        <!-- Bot√≥n: Nueva Exportaci√≥n -->
                        <button name="action_restart" 
                                type="object" 
                                string="Nueva Exportaci√≥n" 
                                class="btn-secondary" 
                                invisible="state == 'draft' or state == 'preview'"
                                icon="fa-refresh"/>
                        
                        <!-- Bot√≥n: Debug PDF -->
                        <button name="action_debug_pdf_generation" 
                                type="object" 
                                string="Debug PDF" 
                                class="btn-secondary" 
                                invisible="state != 'preview'"
                                icon="fa-bug"
                                groups="base.group_system"/>
                        
                        <!-- Barra de estado -->
                        <field name="state" 
                               widget="statusbar" 
                               statusbar_visible="draft,preview,processing,done"/>
                    </header>

                    <!-- Contenido principal -->
                    <sheet>
                        
                        <!-- T√≠tulo del wizard -->
                        <div class="oe_title">
                            <h1>
                                <i class="fa fa-file-archive-o" title="Archivo comprimido"/> Exportaci√≥n Masiva de Facturas
                            </h1>
                            <p class="text-muted">
                                Exporta m√∫ltiples facturas a un archivo comprimido con PDFs reales
                            </p>
                        </div>

                        <!-- ============================================ -->
                        <!-- ESTADO: CONFIGURACI√ìN -->
                        <!-- ============================================ -->
                        <div invisible="state != 'draft'">

                            <group string="üìã Configuraci√≥n B√°sica">
                                <group>
                                    <field name="company_id" 
                                           options="{'no_create': True, 'no_open': True}"/>
                                    
                                    <field name="compression_format" 
                                           widget="radio"/>
                                    
                                    <field name="archive_password" 
                                           password="True" 
                                           invisible="compression_format != 'zip_password'" 
                                           required="compression_format == 'zip_password'"
                                           placeholder="Ingrese contrase√±a segura..."/>
                                </group>
                                
                                <group>
                                    <field name="filename_pattern" 
                                           widget="radio"/>
                                    
                                    <field name="batch_size" 
                                           widget="integer"
                                           help="Recomendado: 50 para balance entre velocidad y memoria"/>
                                </group>
                            </group>

                            <!-- Opciones Avanzadas -->
                            <group string="‚öôÔ∏è Opciones Avanzadas">
                                <field name="organize_by_type" 
                                       string="üìÅ Organizar en carpetas por tipo de documento"/>
                            </group>

                            <!-- Selecci√≥n de Facturas -->
                            <group string="üìÑ Selecci√≥n de Facturas" invisible="selected_count > 0">
                                <p class="alert alert-info" role="alert" colspan="2">
                                    <i class="fa fa-info-circle" title="Informaci√≥n"/> 
                                    <b>Modo de Selecci√≥n:</b> No hay facturas pre-seleccionadas. 
                                    Use los filtros abajo para definir qu√© facturas exportar.
                                </p>
                            </group>

                            <!-- Facturas Pre-seleccionadas -->
                            <div invisible="selected_count == 0">
                                <group string="‚úÖ Facturas Pre-seleccionadas">
                                    <div class="alert alert-success" role="alert" colspan="2">
                                        <h4>
                                            <i class="fa fa-check-circle" title="√âxito"/> 
                                            <field name="selected_count"/> facturas pre-seleccionadas
                                        </h4>
                                        <p>Las facturas han sido seleccionadas desde la vista de lista. 
                                           Los filtros abajo no se aplicar√°n.</p>
                                    </div>
                                    
                                    <field name="invoice_ids" 
                                           widget="many2many_tags" 
                                           options="{'no_create': True, 'color_field': 'state'}" 
                                           colspan="2"
                                           readonly="1"/>
                                </group>
                            </div>

                            <!-- Filtros de Documentos (solo si no hay pre-selecci√≥n) -->
                            <group string="üîç Filtros de Documentos" 
                                   invisible="selected_count > 0">
                                
                                <group string="Tipos de Documento">
                                    <field name="include_out_invoice" 
                                           string="üì§ Facturas de Cliente"/>
                                    <field name="include_in_invoice" 
                                           string="üì• Facturas de Proveedor"/>
                                    <field name="include_out_refund" 
                                           string="‚Ü©Ô∏è Notas de Cr√©dito de Cliente"/>
                                    <field name="include_in_refund" 
                                           string="‚Ü™Ô∏è Notas de Cr√©dito de Proveedor"/>
                                </group>
                                
                                <group string="Filtros Adicionales">
                                    <field name="date_from" 
                                           string="üìÖ Desde Fecha"/>
                                    <field name="date_to" 
                                           string="üìÖ Hasta Fecha"/>
                                    <field name="state_filter" 
                                           string="üìä Estado"/>
                                    <field name="partner_ids" 
                                           widget="many2many_tags" 
                                           options="{'no_create': True}"
                                           placeholder="Dejar vac√≠o para todos..."/>
                                </group>
                            </group>

                        </div>

                        <!-- ============================================ -->
                        <!-- ESTADO: VISTA PREVIA -->
                        <!-- ============================================ -->
                        <div invisible="state != 'preview'">

                            <div class="alert alert-info" role="alert">
                                <h3><i class="fa fa-search" title="Buscar"/> Vista Previa de Exportaci√≥n</h3>
                                <p>Revise los detalles de las facturas que se exportar√°n antes de continuar.</p>
                            </div>

                            <group string="üìä Estad√≠sticas de Exportaci√≥n">
                                <group>
                                    <field name="preview_invoice_count" 
                                           readonly="1" 
                                           string="Total Facturas"/>
                                    <field name="preview_out_invoice_count" 
                                           readonly="1" 
                                           string="üì§ Facturas Cliente"/>
                                    <field name="preview_in_invoice_count" 
                                           readonly="1" 
                                           string="üì• Facturas Proveedor"/>
                                </group>
                                
                                <group>
                                    <field name="preview_out_refund_count" 
                                           readonly="1" 
                                           string="‚Ü©Ô∏è NC Cliente"/>
                                    <field name="preview_in_refund_count" 
                                           readonly="1" 
                                           string="‚Ü™Ô∏è NC Proveedor"/>
                                    <field name="preview_total_amount" 
                                           readonly="1" 
                                           widget="monetary" 
                                           string="üí∞ Importe Total"
                                           options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" invisible="1"/>
                                </group>
                            </group>

                            <!-- Resumen de Configuraci√≥n -->
                            <group string="‚öôÔ∏è Configuraci√≥n de Exportaci√≥n">
                                <group>
                                    <field name="compression_format" readonly="1"/>
                                    <field name="filename_pattern" readonly="1"/>
                                    <field name="organize_by_type" readonly="1"/>
                                </group>
                                <group>
                                    <field name="batch_size" readonly="1"/>
                                    <field name="company_id" readonly="1"/>
                                </group>
                            </group>

                            <!-- Advertencia si hay muchas facturas -->
                            <div class="alert alert-warning" role="alert"
                                 invisible="preview_invoice_count &lt; 200">
                                <p>
                                    <i class="fa fa-exclamation-triangle" title="Advertencia"/> 
                                    <b>Nota:</b> Est√° a punto de exportar m√°s de 200 facturas. 
                                    El proceso puede tardar varios minutos. 
                                    Considere filtrar por fechas si es necesario.
                                </p>
                            </div>

                        </div>

                        <!-- ============================================ -->
                        <!-- ESTADO: PROCESANDO -->
                        <!-- ============================================ -->
                        <div invisible="state != 'processing'">
                            
                            <div class="alert alert-warning" role="status">
                                <h3>
                                    <i class="fa fa-spinner fa-spin" title="Procesando"/> Procesando Exportaci√≥n
                                </h3>
                                <p>Por favor espere mientras se generan los PDFs y se crea el archivo comprimido...</p>
                            </div>

                            <!-- Barra de Progreso -->
                            <group>
                                <field name="progress_percentage" 
                                       widget="progressbar" 
                                       readonly="1" 
                                       string="Progreso"/>
                                
                                <field name="progress_message" 
                                       readonly="1" 
                                       string="Estado Actual"/>
                            </group>

                            <div class="text-center">
                                <p class="text-muted">
                                    <i class="fa fa-clock-o" title="Tiempo"/> 
                                    Este proceso puede tardar dependiendo de la cantidad de facturas.
                                </p>
                            </div>

                        </div>

                        <!-- ============================================ -->
                        <!-- ESTADO: COMPLETADO -->
                        <!-- ============================================ -->
                        <div invisible="state != 'done'">
                            
                            <div class="alert alert-success" role="alert">
                                <h3>
                                    <i class="fa fa-check-circle" title="Completado"/> ¬°Exportaci√≥n Completada!
                                </h3>
                                <p>
                                    Se han exportado <strong><field name="export_count"/> facturas</strong> 
                                    en <strong><field name="processing_time"/> segundos</strong>.
                                </p>
                            </div>

                            <!-- Estad√≠sticas del Resultado -->
                            <group string="üìä Resultados de la Exportaci√≥n">
                                <group>
                                    <field name="export_count" 
                                           readonly="1" 
                                           string="‚úÖ Facturas Exportadas"
                                           widget="integer"/>
                                    
                                    <field name="failed_count" 
                                           readonly="1" 
                                           string="‚ùå Facturas Fallidas" 
                                           invisible="failed_count == 0"
                                           widget="integer"/>
                                    
                                </group>
                                
                                <group>
                                    <field name="processing_time" 
                                           readonly="1" 
                                           string="‚è±Ô∏è Tiempo de Procesamiento"
                                           widget="float_time"/>
                                    
                                    <field name="file_size_mb" 
                                           readonly="1" 
                                           string="üíæ Tama√±o del Archivo"
                                           widget="float"/>
                                    
                                    <field name="export_filename" 
                                           readonly="1" 
                                           string="üì¶ Nombre del Archivo"/>
                                </group>
                            </group>

                            <!-- Archivo para Descargar -->
                            <group string="üì• Descargar Archivo">
                                <field name="export_file" 
                                       filename="export_filename" 
                                       readonly="1"
                                       widget="binary"
                                       string="Archivo Comprimido"/>
                            </group>

                            <!-- Advertencia sobre Facturas Fallidas -->
                            <div class="alert alert-warning" role="alert"
                                 invisible="failed_count == 0">
                                <p>
                                    <i class="fa fa-exclamation-triangle" title="Advertencia"/> 
                                    <b>Atenci√≥n:</b> 
                                    <field name="failed_count"/> facturas no pudieron ser exportadas.
                                    Revise los logs del sistema para m√°s detalles.
                                </p>
                            </div>

                        </div>

                        <!-- ============================================ -->
                        <!-- ESTADO: ERROR -->
                        <!-- ============================================ -->
                        <div invisible="state != 'error'">
                            
                            <div class="alert alert-danger" role="alert">
                                <h3>
                                    <i class="fa fa-times-circle" title="Error"/> Error en la Exportaci√≥n
                                </h3>
                                <p>Se produjo un error durante el proceso de exportaci√≥n.</p>
                            </div>

                            <group string="Detalles del Error">
                                <field name="error_message" 
                                       readonly="1" 
                                       widget="text" 
                                       nolabel="1" 
                                       colspan="2"/>
                            </group>

                            <div class="text-center">
                                <p class="text-muted">
                                    Contacte al administrador del sistema si el problema persiste.
                                </p>
                            </div>

                        </div>

                    </sheet>

                    <!-- Footer del formulario -->
                    <footer>
                        <button string="Cerrar" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>

                </form>
            </field>
        </record>

        <!-- Acci√≥n del wizard -->
        <record id="action_bulk_export_wizard" model="ir.actions.act_window">
            <field name="name">Exportaci√≥n Masiva de Facturas</field>
            <field name="res_model">account.bulk.export.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="view_id" ref="view_bulk_export_wizard_form"/>
            <field name="binding_model_id" ref="account.model_account_move"/>
            <field name="binding_view_types">list</field>
            <field name="context">{'default_invoice_ids': active_ids}</field>
        </record>
        
        <!-- Acci√≥n para el men√∫ principal -->
        <record id="action_bulk_export_wizard_menu" model="ir.actions.act_window">
            <field name="name">Exportaci√≥n Masiva de Facturas</field>
            <field name="res_model">account.bulk.export.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="view_id" ref="view_bulk_export_wizard_form"/>
            <field name="context">{}</field>
        </record>

    </data>
</odoo>
