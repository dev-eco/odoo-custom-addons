<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Vista principal del wizard completamente redise√±ada -->
        <record id="view_bulk_export_wizard_form" model="ir.ui.view">
            <field name="name">account.bulk.export.wizard.form</field>
            <field name="model">account.bulk.export.wizard</field>
            <field name="arch" type="xml">
                <form string="Exportaci√≥n Masiva de Facturas" class="o_bulk_export_wizard">
                    
                    <!-- Header con botones y barra de estado -->
                    <header>
                        <field name="state" invisible="1"/>
                        
                        <!-- Botones principales -->
                        <button name="action_start_export" 
                                type="object" 
                                string="üöÄ Iniciar Exportaci√≥n" 
                                class="btn-primary" 
                                invisible="state != 'draft'"
                                confirm="¬øEst√° seguro de iniciar la exportaci√≥n con la configuraci√≥n actual?"/>
                        
                        <button name="action_download" 
                                type="object" 
                                string="üì• Descargar Archivo" 
                                class="btn-success" 
                                invisible="state != 'done'"/>
                        
                        <button name="action_restart" 
                                type="object" 
                                string="üîÑ Nueva Exportaci√≥n" 
                                class="btn-secondary" 
                                invisible="state == 'draft'"/>
                        
                        <button name="action_diagnose_pdf_issues" 
                                type="object" 
                                string="üîß Diagn√≥stico" 
                                class="btn-warning" 
                                invisible="state not in ['draft', 'error']"
                                help="Ejecutar diagn√≥stico del sistema PDF"/>
                        
                        <!-- Barra de estado -->
                        <field name="state" 
                               widget="statusbar" 
                               statusbar_visible="draft,processing,done"
                               statusbar_colors='{"processing":"blue","done":"green","error":"red"}'/>
                    </header>

                    <!-- Contenido principal -->
                    <sheet>
                        
                        <!-- T√≠tulo din√°mico -->
                        <div class="oe_title">
                            <h1>
                                <i class="fa fa-file-archive-o"/> 
                                Exportaci√≥n Masiva de Facturas
                            </h1>
                            <h2 invisible="state != 'processing'">
                                <i class="fa fa-spinner fa-spin"/> Procesando...
                            </h2>
                        </div>

                        <!-- Informaci√≥n contextual -->
                        <div class="alert alert-info" invisible="not context_info">
                            <field name="context_info" nolabel="1"/>
                        </div>

                        <!-- Mensaje de procesamiento con progreso -->
                        <div class="alert alert-warning" invisible="state != 'processing'">
                            <h4><i class="fa fa-cog fa-spin"/> Procesando Exportaci√≥n</h4>
                            <p>Por favor espere mientras se procesan las facturas...</p>
                            <div invisible="progress_percentage == 0">
                                <p><strong>Progreso:</strong> <field name="progress_percentage"/>%</p>
                            </div>
                            <p invisible="not progress_message">
                                <strong>Estado:</strong> <field name="progress_message"/>
                            </p>
                        </div>

                        <!-- Mensaje de error detallado -->
                        <div class="alert alert-danger" invisible="state != 'error'">
                            <h4><i class="fa fa-exclamation-triangle"/> Error en la Exportaci√≥n</h4>
                            <field name="error_message" readonly="1" widget="text"/>
                            <p class="mt-2">
                                <em>Sugerencia: Use el bot√≥n "Diagn√≥stico" para identificar problemas del sistema.</em>
                            </p>
                        </div>

                        <!-- Mensaje de √©xito con estad√≠sticas -->
                        <div class="alert alert-success" invisible="state != 'done'">
                            <h4><i class="fa fa-check-circle"/> ¬°Exportaci√≥n Completada Exitosamente!</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>üìä Estad√≠sticas:</strong></p>
                                    <ul class="list-unstyled">
                                        <li>‚úÖ Facturas exportadas: <strong><field name="export_count"/></strong></li>
                                        <li invisible="failed_count == 0" class="text-warning">
                                            ‚ùå Facturas fallidas: <strong><field name="failed_count"/></strong>
                                        </li>
                                        <li invisible="attachments_count == 0">
                                            üìé Adjuntos incluidos: <strong><field name="attachments_count"/></strong>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>‚ö° Rendimiento:</strong></p>
                                    <ul class="list-unstyled">
                                        <li>‚è±Ô∏è Tiempo: <strong><field name="processing_time"/> segundos</strong></li>
                                        <li>üì¶ Tama√±o: <strong><field name="file_size_mb"/> MB</strong></li>
                                        <li>üìÑ Archivo: <strong><field name="export_filename"/></strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Configuraci√≥n - solo visible en draft -->
                        <div invisible="state != 'draft'">
                            
                            <!-- Configuraci√≥n b√°sica -->
                            <group string="‚öôÔ∏è Configuraci√≥n B√°sica">
                                <group>
                                    <field name="company_id" 
                                           options="{'no_create': True, 'no_edit': True}"/>
                                    <field name="state_filter" widget="radio" options="{'horizontal': true}"/>
                                </group>
                                <group>
                                    <field name="estimated_count" 
                                           invisible="invoice_ids"/>
                                    <field name="estimated_time" 
                                           invisible="invoice_ids or estimated_count == 0"/>
                                </group>
                            </group>

                            <!-- Selecci√≥n de facturas -->
                            <group string="üìã Selecci√≥n de Facturas" invisible="invoice_ids">
                                <group string="Tipos de Documento">
                                    <field name="include_out_invoice"/>
                                    <field name="include_in_invoice"/>
                                    <field name="include_out_refund"/>
                                    <field name="include_in_refund"/>
                                </group>
                                <group string="Filtros de Fecha">
                                    <field name="date_from"/>
                                    <field name="date_to"/>
                                </group>
                            </group>

                            <!-- Filtros adicionales -->
                            <group string="üîç Filtros Adicionales" invisible="invoice_ids">
                                <group>
                                    <field name="partner_ids" 
                                           widget="many2many_tags" 
                                           options="{'no_create': True}"/>
                                    <field name="user_id" 
                                           options="{'no_create': True}"/>
                                </group>
                                <group>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="amount_from" 
                                           widget="monetary" 
                                           options="{'currency_field': 'currency_id'}"/>
                                    <field name="amount_to" 
                                           widget="monetary" 
                                           options="{'currency_field': 'currency_id'}"/>
                                </group>
                            </group>

                            <!-- Facturas pre-seleccionadas -->
                            <group string="üìå Facturas Preseleccionadas" invisible="not invoice_ids">
                                <field name="selected_count"/>
                                <field name="invoice_ids" 
                                       widget="many2many_tags" 
                                       options="{'no_create': True}" 
                                       nolabel="1"/>
                            </group>

                            <!-- Opciones de formato y compresi√≥n -->
                            <group string="üì¶ Formato y Compresi√≥n">
                                <group>
                                    <field name="compression_format" widget="radio"/>
                                    <field name="archive_password" 
                                           invisible="compression_format != 'zip_password'"
                                           password="True"/>
                                </group>
                                <group>
                                    <field name="filename_pattern" widget="selection"/>
                                    <field name="custom_filename_pattern" 
                                           invisible="filename_pattern != 'custom'"
                                           placeholder="Ej: {partner}_{type}_{number}_{date}"/>
                                </group>
                            </group>

                            <!-- Opciones de organizaci√≥n -->
                            <group string="üìÅ Organizaci√≥n del Contenido">
                                <group>
                                    <field name="group_by_partner"/>
                                    <field name="group_by_type"/>
                                    <field name="group_by_month"/>
                                </group>
                                <group>
                                    <field name="include_attachments"/>
                                    <field name="include_xml"/>
                                </group>
                            </group>

                            <!-- Opciones avanzadas -->
                            <group string="‚ö° Opciones Avanzadas" groups="base.group_no_one">
                                <group>
                                    <field name="batch_size"/>
                                    <field name="use_background_processing" 
                                           invisible="estimated_count &lt; 100"/>
                                </group>
                                <group>
                                    <field name="optimize_pdf_size"/>
                                </group>
                            </group>

                        </div>

                        <!-- Resultados detallados - solo visible cuando est√° done -->
                        <div invisible="state != 'done'">
                            <group string="üìä Resultados Detallados">
                                <group>
                                    <field name="export_count" readonly="1"/>
                                    <field name="failed_count" readonly="1" 
                                           invisible="failed_count == 0"/>
                                    <field name="attachments_count" readonly="1"
                                           invisible="attachments_count == 0"/>
                                </group>
                                <group>
                                    <field name="processing_time" readonly="1"/>
                                    <field name="file_size_mb" readonly="1"/>
                                    <field name="export_filename" readonly="1"/>
                                </group>
                            </group>
                        </div>

                    </sheet>

                    <!-- Footer con botones adicionales -->
                    <footer>
                        <button string="‚ùå Cerrar" 
                                class="btn-secondary" 
                                special="cancel"/>
                        
                        <button string="üìö Ver Historial" 
                                type="object" 
                                name="action_view_history"
                                class="btn-link"
                                invisible="state == 'processing'"/>
                    </footer>

                </form>
            </field>
        </record>

        <!-- Acci√≥n principal desde el men√∫ -->
        <record id="action_bulk_export_wizard_menu" model="ir.actions.act_window">
            <field name="name">Exportaci√≥n Masiva de Facturas</field>
            <field name="res_model">account.bulk.export.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¬°Exporte m√∫ltiples facturas de forma masiva!
                </p>
                <p>
                    Esta herramienta le permite exportar m√∫ltiples facturas a un archivo comprimido
                    con opciones avanzadas de filtrado y organizaci√≥n.
                </p>
            </field>
        </record>

        <!-- Acci√≥n desde la vista lista de facturas -->
        <record id="action_bulk_export_from_list" model="ir.actions.act_window">
            <field name="name">Exportar Facturas Seleccionadas</field>
            <field name="res_model">account.bulk.export.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="context">{'default_invoice_ids': active_ids}</field>
            <field name="binding_model_id" ref="account.model_account_move"/>
            <field name="binding_view_types">list</field>
        </record>

    </data>
</odoo>
